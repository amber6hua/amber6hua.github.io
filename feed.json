{
    "version": "https://jsonfeed.org/version/1",
    "title": "Amber",
    "subtitle": "六花丶紫",
    "icon": "https://ambercc.gitee.io/images/favicon.ico",
    "description": "Amber Room",
    "home_page_url": "https://ambercc.gitee.io",
    "items": [
        {
            "id": "https://ambercc.gitee.io/fastadmin/fastadmin-doc-8/",
            "url": "https://ambercc.gitee.io/fastadmin/fastadmin-doc-8/",
            "title": "FastAdmin 个人记录 - 修改table传递的参数",
            "date_published": "2022-08-19T03:05:02.000Z",
            "content_html": "<h2 id=\"后台php修改\"><a class=\"anchor\" href=\"#后台php修改\">#</a> 后台 php 修改</h2>\n<figure class=\"highlight php\"><figcaption data-lang=\"PHP\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#一般我们可以直接在控制器中使用以下代码获取请求的参数：</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token variable\">$filter</span> <span class=\"token operator\">=</span> <span class=\"token function\">json_decode</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">request</span><span class=\"token operator\">-></span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"filter\"</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token variable\">$op</span> <span class=\"token operator\">=</span> <span class=\"token function\">json_decode</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">request</span><span class=\"token operator\">-></span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"op\"</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'trim'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">#通过 isset () 函数判断是否存在某个参数，然后利用 unset () 去除你不需要的参数；再通过</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token variable\">$filter</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token variable\">$op</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">#设置你的自定义参数和查询条件；</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">#然后进行重新赋值：</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">request</span><span class=\"token operator\">-></span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'filter'</span> <span class=\"token operator\">=></span> <span class=\"token function\">json_encode</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$filter</span><span class=\"token punctuation\">,</span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">request</span><span class=\"token operator\">-></span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'op'</span> <span class=\"token operator\">=></span> <span class=\"token function\">json_encode</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$op</span><span class=\"token punctuation\">,</span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">list</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$where</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$sort</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$order</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$offset</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$limit</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token function\">buildparams</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h2 id=\"前台table-js修改\"><a class=\"anchor\" href=\"#前台table-js修改\">#</a> 前台 table js 修改</h2>\n<figure class=\"highlight javascript\"><figcaption data-lang=\"javascript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>table<span class=\"token punctuation\">.</span><span class=\"token function\">bootstrapTable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    url<span class=\"token operator\">:</span> $<span class=\"token punctuation\">.</span>fn<span class=\"token punctuation\">.</span>bootstrapTable<span class=\"token punctuation\">.</span>defaults<span class=\"token punctuation\">.</span>extend<span class=\"token punctuation\">.</span>index_url<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    pk<span class=\"token operator\">:</span> <span class=\"token string\">'id'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    sortName<span class=\"token operator\">:</span> <span class=\"token string\">'id'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    searchFormVisible<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    toolbar<span class=\"token operator\">:</span> <span class=\"token string\">'#toolbar'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token function-variable function\">queryParams</span><span class=\"token operator\">:</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">params</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">let</span> filter <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">.</span>filter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">let</span> op <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">.</span>op<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        </pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token comment\">// 重构搜索条件 根据个人需求修改</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>filter<span class=\"token punctuation\">[</span><span class=\"token string\">'status'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            filter<span class=\"token punctuation\">[</span><span class=\"token string\">'status'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            op<span class=\"token punctuation\">[</span><span class=\"token string\">'status'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">'>'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            params<span class=\"token punctuation\">.</span>filter <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>filter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            params<span class=\"token punctuation\">.</span>op <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>op<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            <span class=\"token comment\">//console.log(params);</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token keyword\">return</span> params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    columns<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        col</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure>",
            "tags": [
                "FastAdmin",
                "教程",
                "FastAdmin"
            ]
        },
        {
            "id": "https://ambercc.gitee.io/chrome-hevc/",
            "url": "https://ambercc.gitee.io/chrome-hevc/",
            "title": "Chrome支持HEVC",
            "date_published": "2022-08-12T09:46:22.000Z",
            "content_html": "<h2 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h2>\n<p>明明都是 mp4 格式，为什么有的视频，在 h5 播放器播放，只有声音，没有画面<br />\n常见的 mp4 编码为 H.264 能正常播放<br />\n而 H.265 (HEVC) 编码的视频就会发生无法正常播放的情况</p>\n<p>本来想找个好用的 h5 播放器，但是都不好用</p>\n<p>然后发现了个帖子，有位老哥之前做了可以让谷歌浏览器支持 HEVC</p>\n<p>最近谷歌浏览器也更新了 (version&gt;= 104.0.5084.0) 支持了 HEVC 解码</p>\n<h2 id=\"chrome设置启动参数\"><a class=\"anchor\" href=\"#chrome设置启动参数\">#</a> chrome 设置启动参数</h2>\n<p>在 chrome 桌面快捷方式设置 启动参数 --enable-features=&quot;PlatformHEVCDecoderSupport&quot;</p>\n<p>选择快捷方式图标<br />\n右键展开菜单<br />\n选择属性<br />\n快捷方式分页中 在” 目标 “输入框中 末尾加上 --enable-features=&quot;PlatformHEVCDecoderSupport&quot;<br />\n 然后重新打开浏览器，就可以了</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 例子</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token string\">\"C:\\Program Files\\Google\\Chrome\\Application<span class=\"token entity\" title=\"\\c\">\\c</span>hrome.exe\"</span> --enable-features<span class=\"token operator\">=</span><span class=\"token string\">\"PlatformHEVCDecoderSupport\"</span></pre></td></tr></table></figure><div class=\"note info\">\n<p>浏览器版本不够的不想更新的，可以根据参考链接实现</p>\n</div>\n<h2 id=\"参考链接\"><a class=\"anchor\" href=\"#参考链接\">#</a> 参考链接</h2>\n<ul>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuYmlsaWJpbGkuY29tL3JlYWQvY3YxNjI5MzI4NS8=\">https://www.bilibili.com/read/cv16293285/</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL1N0YVpodS9lbmFibGUtY2hyb21pdW0taGV2Yy1oYXJkd2FyZS1kZWNvZGluZw==\">https://github.com/StaZhu/enable-chromium-hevc-hardware-decoding</span></li>\n</ul>\n",
            "tags": [
                "教程",
                "教程"
            ]
        },
        {
            "id": "https://ambercc.gitee.io/hexo/hello-world/",
            "url": "https://ambercc.gitee.io/hexo/hello-world/",
            "title": "Hello World",
            "date_published": "2022-08-01T09:41:43.226Z",
            "content_html": "<p>Welcome to <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvLw==\">Hexo</span>! This is your very first post. Check <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3Mv\">documentation</span> for more info. If you get any problems when using Hexo, you can find the answer in <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3MvdHJvdWJsZXNob290aW5nLmh0bWw=\">troubleshooting</span> or you can ask me on <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2hleG9qcy9oZXhvL2lzc3Vlcw==\">GitHub</span>.</p>\n<h2 id=\"quick-start\"><a class=\"anchor\" href=\"#quick-start\">#</a> Quick Start</h2>\n<h3 id=\"create-a-new-post\"><a class=\"anchor\" href=\"#create-a-new-post\">#</a> Create a new post</h3>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"><span>h</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ hexo new <span class=\"token string\">\"My New Post\"</span></pre></td></tr></table></figure><p>More info: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3Mvd3JpdGluZy5odG1s\">Writing</span></p>\n<h3 id=\"run-server\"><a class=\"anchor\" href=\"#run-server\">#</a> Run server</h3>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"><span>h</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ hexo server</pre></td></tr></table></figure><p>More info: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3Mvc2VydmVyLmh0bWw=\">Server</span></p>\n<h3 id=\"generate-static-files\"><a class=\"anchor\" href=\"#generate-static-files\">#</a> Generate static files</h3>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"><span>h</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ hexo generate</pre></td></tr></table></figure><p>More info: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3MvZ2VuZXJhdGluZy5odG1s\">Generating</span></p>\n<h3 id=\"deploy-to-remote-sites\"><a class=\"anchor\" href=\"#deploy-to-remote-sites\">#</a> Deploy to remote sites</h3>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"><span>h</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ hexo deploy</pre></td></tr></table></figure><p>More info: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3Mvb25lLWNvbW1hbmQtZGVwbG95bWVudC5odG1s\">Deployment</span></p>\n",
            "tags": [
                "hexo",
                "教程",
                "hexo"
            ]
        },
        {
            "id": "https://ambercc.gitee.io/onedrive-download-aria/",
            "url": "https://ambercc.gitee.io/onedrive-download-aria/",
            "title": "OneDrive SharePoint 利用Aria下载",
            "date_published": "2022-07-27T03:40:51.000Z",
            "content_html": "<h2 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h2>\n<p>记录在 windows 下 OneDrive SharePoint 下载的两种办法 ，并且利用到 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2FyaWEyL2FyaWEyL3JlbGVhc2Vz\"> Aria2 下载器</span></p>\n<ul>\n<li>\n<p>油猴脚本 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9ncmVhc3lmb3JrLm9yZy96aC1DTi9zY3JpcHRzLzQzMjQxNS1vbmVkcml2ZS0lRTYlOTYlODclRTQlQkIlQjYlRTQlQjglOEIlRTglQkQlQkQlRTclOUIlQjQlRTklOTMlQkU=\">onedrive - 文件下载直链</span></p>\n</li>\n<li>\n<p>python 脚本 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2dhb3dhbmxpYW5nL09uZURyaXZlU2hhcmVMaW5rUHVzaEFyaWEy\">OneDriveShareLinkPushAria2</span></p>\n</li>\n</ul>\n<h2 id=\"启动aria2\"><a class=\"anchor\" href=\"#启动aria2\">#</a> 启动 Aria2</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2FyaWEyL2FyaWEyL3JlbGVhc2Vz\"> Aria2 下载器</span><br />\n解压后获得 Aria2 的文件夹<br />\n免安装，直接执行 aria2.exe 文件</p>\n<p>图形化界面 aria2Ng/index.html</p>\n<div class=\"note info\">\n<p>踩坑<br />\n默认下载内容中有 torrent 种子文件时，会自动下载<br />\n不需要的话修改，修改配置文件 aria2.conf<br />\n 当下载的是一个种子 (以.torrent 结尾) 时，自动开始 BT 任务，默认:true<br />\nfollow-torrent=false</p>\n</div>\n<h2 id=\"油猴脚本\"><a class=\"anchor\" href=\"#油猴脚本\">#</a> 油猴脚本</h2>\n<ul>\n<li>首先要给浏览器安装一个的拓展程序 TamperMonkey Beta (油猴)</li>\n<li>然后 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9ncmVhc3lmb3JrLm9yZw==\">Greasy Fork</span> 脚本网站中找到 onedrive - 文件下载直链</li>\n</ul>\n<p>使用方便，但是不能区分文件夹<br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ncmVhc3lmb3JrLm9yZy96aC1DTi9zY3JpcHRzLzQzMjQxNS1vbmVkcml2ZS0lRTYlOTYlODclRTQlQkIlQjYlRTQlQjglOEIlRTglQkQlQkQlRTclOUIlQjQlRTklOTMlQkU=\"> onedrive - 文件下载直链</span><br />\n获得 OneDrive（Sharepoint，支持世纪互联） 文件下载直链的 TamperMonkey 插件。支持 IDM 批量下载、Aria2 推送下载</p>\n<h2 id=\"python脚本\"><a class=\"anchor\" href=\"#python脚本\">#</a> python 脚本</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2dhb3dhbmxpYW5nL09uZURyaXZlU2hhcmVMaW5rUHVzaEFyaWEy\">OneDriveShareLinkPushAria2</span></p>\n<blockquote>\n<p>ShareLink 分享的资源多，但是没法像百度网盘一样直接保存到自己的网盘中，下载内容多的时候也麻烦<br />\n这个脚本，通过把下载内容推送到 Aria2，并且包含目录层级<br />\n从 OneDrive 或 SharePoint 共享链接提取下载 URL 并将其推送到 aria2，即使在无图形界面的系统中 (如 Linux) 依然可以使用。</p>\n</blockquote>\n<p>下载完成后，需要准备好 python 环境<br />\n具体使用就不介绍了，除了分享链接，都是使用默认配置</p>\n<div class=\"note info\">\n<p>使用过程中 遇到下载的内容只有 507b<br />\n 看 issues 是请求频繁问题<br />\n我是在推送之前增加了一秒延迟<br />\n <code># todo</code>  下就是我加的代码</p>\n</div>\n<blockquote>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL3huLS1tYWluLWZ0NGd1OWg5MjdoLnB5\">大致在 main.py</span> 的 326 行</p>\n</blockquote>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> time</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># 省略部分代码</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token keyword\">if</span> i<span class=\"token punctuation\">[</span><span class=\"token string\">'FSObjType'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token string\">\"1\"</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            <span class=\"token comment\"># 省略部分代码</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            <span class=\"token comment\"># todo</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token keyword\">if</span> fileCount <span class=\"token operator\">+</span> <span class=\"token number\">1</span> <span class=\"token operator\">==</span> <span class=\"token builtin\">min</span><span class=\"token punctuation\">(</span>num<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                time<span class=\"token punctuation\">.</span>sleep<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token keyword\">if</span> fileCount <span class=\"token operator\">></span> <span class=\"token builtin\">max</span><span class=\"token punctuation\">(</span>num<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                <span class=\"token keyword\">break</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            <span class=\"token keyword\">if</span> num <span class=\"token operator\">==</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">or</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">isinstance</span><span class=\"token punctuation\">(</span>num<span class=\"token punctuation\">,</span> <span class=\"token builtin\">list</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">and</span> fileCount <span class=\"token keyword\">in</span> num<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                <span class=\"token comment\"># todo</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                time<span class=\"token punctuation\">.</span>sleep<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\t\"</span> <span class=\"token operator\">*</span> layers<span class=\"token punctuation\">,</span> <span class=\"token string\">\"文件 [%d]：%s\\t独特ID：%s\\t正在推送\"</span> <span class=\"token operator\">%</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                      <span class=\"token punctuation\">(</span>fileCount<span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">[</span><span class=\"token string\">'FileLeafRef'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">[</span><span class=\"token string\">\"UniqueId\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                <span class=\"token comment\"># 省略部分代码</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                <span class=\"token comment\"># exit(0)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\t\"</span> <span class=\"token operator\">*</span> layers<span class=\"token punctuation\">,</span> <span class=\"token string\">\"文件 [%d]：%s\\t独特ID：%s\\t非目标文件\"</span> <span class=\"token operator\">%</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                      <span class=\"token punctuation\">(</span>fileCount<span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">[</span><span class=\"token string\">'FileLeafRef'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">[</span><span class=\"token string\">\"UniqueId\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure>",
            "tags": [
                "教程",
                "教程"
            ]
        },
        {
            "id": "https://ambercc.gitee.io/linux/linux-service-systemctl/",
            "url": "https://ambercc.gitee.io/linux/linux-service-systemctl/",
            "title": "linux 下nginx加入 service systemctl",
            "date_published": "2022-07-06T08:57:28.000Z",
            "content_html": "<h2 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h2>\n<blockquote>\n<p>nginx 安装成功后，可用使用 安装路径 /sbin/nginx -s start|reopen|reopen 等命令<br />\n也可以加入 service 或 systemctl 方便管理</p>\n</blockquote>\n<h2 id=\"service-配置流程\"><a class=\"anchor\" href=\"#service-配置流程\">#</a> service 配置流程</h2>\n<blockquote>\n<p>编辑编辑<br />\n vi /etc/init.d/nginx<br />\n 软链接 /etc/init.d/ 指向 /etc/rc.d/init.d/<br />\n 只要把下面的路径 改成自己的安装路径 /usr/local/webserver<br />\nNGINX_BIN='/usr/local/webserver/nginx/sbin/nginx'<br />\nCONFIG='/usr/local/webserver/nginx/conf/nginx.conf'<br />\n 保存后修改权限<br />\n chmod 755 nginx<br />\n 设置开启启动<br />\n /sbin/chkconfig nginx on<br />\nservice nginx status 查看是否配置完成</p>\n</blockquote>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token shebang important\">#! /bin/sh</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># chkconfig: 2345 55 25</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># Description: Startup script for nginx webserver on Debian. Place in /etc/init.d and</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># run 'update-rc.d -f nginx defaults', or use the appropriate command on your</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># distro. For CentOS/Redhat run: 'chkconfig --add nginx'</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">### BEGIN INIT INFO</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># Provides:          nginx</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\"># Required-Start:    $all</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># Required-Stop:     $all</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># Default-Start:     2 3 4 5</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># Default-Stop:      0 1 6</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># Short-Description: starts the nginx web server</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\"># Description:       starts nginx using start-stop-daemon</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\">### END INIT INFO</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\"># Author:   licess</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\"># website:  https://lnmp.org</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token assign-left variable\">NGINX_BIN</span><span class=\"token operator\">=</span><span class=\"token string\">'/usr/local/webserver/nginx/sbin/nginx'</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token assign-left variable\">CONFIG</span><span class=\"token operator\">=</span><span class=\"token string\">'/usr/local/webserver/nginx/conf/nginx.conf'</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token keyword\">case</span> <span class=\"token string\">\"<span class=\"token variable\">$1</span>\"</span> <span class=\"token keyword\">in</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    start<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token builtin class-name\">echo</span> -n <span class=\"token string\">\"Starting nginx... \"</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token assign-left variable\">PID</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">ps</span> -ef <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> <span class=\"token string\">\"<span class=\"token variable\">$NGINX_BIN</span>\"</span> <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> -v <span class=\"token function\">grep</span> <span class=\"token operator\">|</span> <span class=\"token function\">awk</span> <span class=\"token string\">'&#123;print $2&#125;'</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$PID</span>\"</span> <span class=\"token operator\">!=</span> <span class=\"token string\">\"\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"nginx (pid <span class=\"token variable\">$PID</span>) already running.\"</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token keyword\">fi</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token variable\">$NGINX_BIN</span> -c <span class=\"token variable\">$CONFIG</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$?</span>\"</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\" failed\"</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\" done\"</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        <span class=\"token keyword\">fi</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        <span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    stop<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        <span class=\"token builtin class-name\">echo</span> -n <span class=\"token string\">\"Stoping nginx... \"</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        <span class=\"token assign-left variable\">PID</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">ps</span> -ef <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> <span class=\"token string\">\"<span class=\"token variable\">$NGINX_BIN</span>\"</span> <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> -v <span class=\"token function\">grep</span> <span class=\"token operator\">|</span> <span class=\"token function\">awk</span> <span class=\"token string\">'&#123;print $2&#125;'</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$PID</span>\"</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"nginx is not running.\"</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        <span class=\"token keyword\">fi</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        <span class=\"token variable\">$NGINX_BIN</span> -s stop</pre></td></tr><tr><td data-num=\"53\"></td><td><pre></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$?</span>\"</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">]</span> <span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>            <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\" failed. Use force-quit\"</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>            <span class=\"token variable\">$0</span> force-quit</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>            <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\" done\"</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        <span class=\"token keyword\">fi</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>        <span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    status<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>        <span class=\"token assign-left variable\">PID</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">ps</span> -ef <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> <span class=\"token string\">\"<span class=\"token variable\">$NGINX_BIN</span>\"</span> <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> -v <span class=\"token function\">grep</span> <span class=\"token operator\">|</span> <span class=\"token function\">awk</span> <span class=\"token string\">'&#123;print $2&#125;'</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$PID</span>\"</span> <span class=\"token operator\">!=</span> <span class=\"token string\">\"\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>            <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"nginx (pid <span class=\"token variable\">$PID</span>) is running...\"</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>        <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>            <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"nginx is stopped.\"</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>            <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>        <span class=\"token keyword\">fi</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>        <span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>    force-quit<span class=\"token operator\">|</span><span class=\"token function\">kill</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>        <span class=\"token builtin class-name\">echo</span> -n <span class=\"token string\">\"Terminating nginx... \"</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>        <span class=\"token assign-left variable\">PID</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">ps</span> -ef <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> <span class=\"token string\">\"<span class=\"token variable\">$NGINX_BIN</span>\"</span> <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> -v <span class=\"token function\">grep</span> <span class=\"token operator\">|</span> <span class=\"token function\">awk</span> <span class=\"token string\">'&#123;print $2&#125;'</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$PID</span>\"</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>            <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"nginx is is stopped.\"</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>            <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>        <span class=\"token keyword\">fi</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>        <span class=\"token function\">kill</span> <span class=\"token variable\">$PID</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$?</span>\"</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>            <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\" failed\"</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>            <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>        <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>            <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\" done\"</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>        <span class=\"token keyword\">fi</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>        <span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>    restart<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>        <span class=\"token variable\">$0</span> stop</pre></td></tr><tr><td data-num=\"93\"></td><td><pre>        <span class=\"token function\">sleep</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>        <span class=\"token variable\">$0</span> start</pre></td></tr><tr><td data-num=\"95\"></td><td><pre>        <span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>    reload<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>        <span class=\"token builtin class-name\">echo</span> -n <span class=\"token string\">\"Reload nginx... \"</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>        <span class=\"token assign-left variable\">PID</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">ps</span> -ef <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> <span class=\"token string\">\"<span class=\"token variable\">$NGINX_BIN</span>\"</span> <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> -v <span class=\"token function\">grep</span> <span class=\"token operator\">|</span> <span class=\"token function\">awk</span> <span class=\"token string\">'&#123;print $2&#125;'</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$PID</span>\"</span> <span class=\"token operator\">!=</span> <span class=\"token string\">\"\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>            <span class=\"token variable\">$NGINX_BIN</span> -s reload</pre></td></tr><tr><td data-num=\"103\"></td><td><pre>            <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\" done\"</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>        <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>            <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"nginx is not running, can't reload.\"</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>            <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>        <span class=\"token keyword\">fi</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>        <span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>    configtest<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>        <span class=\"token builtin class-name\">echo</span> -n <span class=\"token string\">\"Test nginx configure files... \"</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>        <span class=\"token variable\">$NGINX_BIN</span> -t</pre></td></tr><tr><td data-num=\"114\"></td><td><pre>        <span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>    *<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>        <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Usage: <span class=\"token variable\">$0</span> &#123;start|stop|restart|reload|status|configtest|force-quit|kill&#125;\"</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>        <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>        <span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre></pre></td></tr><tr><td data-num=\"121\"></td><td><pre><span class=\"token keyword\">esac</span></pre></td></tr></table></figure><h2 id=\"systemctl-配置流程\"><a class=\"anchor\" href=\"#systemctl-配置流程\">#</a> systemctl 配置流程</h2>\n<blockquote>\n<p>systemctl 兼容 service<br />\n 即 systemctl 可用读取 /etc/init.d/ 下的程序<br />\n完成前面的步骤 可用直接执行 systemctl daemon-reload<br />\nsystemctl status nginx 查看<br />\n另外<br />\n Centos7 的服务 systemctl 脚本存放在：/usr/lib/systemd/ 目录下，有系统（system）和用户（user）之分，一般需要开机不登录就能运行的程序，就存放在 /usr/lib/systemd/system/ 目录下<br />\n /etc/systemd/system/ 软链接 指向 /usr/lib/systemd/system/<br />\nvi /etc/systemd/system/nginx.service<br />\n/usr/local/webserver 换成自己的安装路径<br />\n systemctl daemon-reload 重载 systemctl 配置<br />\n systemctl status nginx 查看状态<br />\n systemctl enable nginx 相当于 /sbin/chkconfig nginx on 设置开启启动</p>\n</blockquote>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>Unit<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token assign-left variable\">Description</span><span class=\"token operator\">=</span>The NGINX HTTP and reverse proxy server</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token assign-left variable\">After</span><span class=\"token operator\">=</span>network.target remote-fs.target nss-lookup.target</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>Service<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token assign-left variable\">Type</span><span class=\"token operator\">=</span>forking</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token assign-left variable\">PIDFile</span><span class=\"token operator\">=</span>/usr/local/webserver/nginx/nginx.pid</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token assign-left variable\">ExecStart</span><span class=\"token operator\">=</span>/usr/local/webserver/nginx/sbin/nginx -c /usr/local/webserver/nginx/conf/nginx.conf</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token assign-left variable\">ExecReload</span><span class=\"token operator\">=</span>/usr/local/webserver/nginx/sbin/nginx -s reload</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token assign-left variable\">ExecStop</span><span class=\"token operator\">=</span>/bin/kill -s QUIT <span class=\"token variable\">$MAINPID</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token assign-left variable\">PrivateTmp</span><span class=\"token operator\">=</span>false</pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">[</span>Install<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token assign-left variable\">WantedBy</span><span class=\"token operator\">=</span>multi-user.target</pre></td></tr></table></figure>",
            "tags": []
        },
        {
            "id": "https://ambercc.gitee.io/linux/linux-php-fpm-sock/",
            "url": "https://ambercc.gitee.io/linux/linux-php-fpm-sock/",
            "title": "Centos下php-fpm使用sock",
            "date_published": "2022-06-22T02:37:16.000Z",
            "content_html": "<h2 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h2>\n<blockquote>\n<p>php-fpm 默认 127.0.0.1:9000, 默认情况下监听端口 9000<br />\n 另外，也可以使 PHP-FPM 使用 Unix 套接字，这避免了 TCP 的开销</p>\n</blockquote>\n<h2 id=\"参考链接\"><a class=\"anchor\" href=\"#参考链接\">#</a> 参考链接</h2>\n<ul>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8yOTY3MTEzNy9hcnRpY2xlL2RldGFpbHMvMTE1NTEzODk2\">https://blog.csdn.net/weixin_29671137/article/details/115513896</span></li>\n</ul>\n<h2 id=\"配置php-fpm\"><a class=\"anchor\" href=\"#配置php-fpm\">#</a> 配置 php-fpm</h2>\n<blockquote>\n<p>我的默认配置路径 （根据个人实际情况）<br />\n/usr/local/php/etc/php-fpm.conf<br />\n/usr/local/php/etc/php-fpm.conf/www.conf</p>\n</blockquote>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">## 部分配置</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>user <span class=\"token operator\">=</span> www</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>group <span class=\"token operator\">=</span> www</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>listen <span class=\"token operator\">=</span> /tmp/php-cgi.sock</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>listen.owner <span class=\"token operator\">=</span> www</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>listen.group <span class=\"token operator\">=</span> www</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>listen.mode <span class=\"token operator\">=</span> 0660</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>listen.allowed_clients <span class=\"token operator\">=</span> <span class=\"token number\">127.0</span>.0.1</pre></td></tr></table></figure><blockquote>\n<p>配置完成后重启 php-fpm, 对应路径会生成 /tmp/php-cgi.sock</p>\n</blockquote>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">service</span> php-fpm restart</pre></td></tr></table></figure><h2 id=\"配置nginx-站点配置-server\"><a class=\"anchor\" href=\"#配置nginx-站点配置-server\">#</a> 配置 nginx 站点配置 server</h2>\n<blockquote>\n<p>我的默认配置路径 （根据个人实际情况）<br />\n/usr/local/webserver/nginx/conf/nginx.conf<br />\n/usr/local/webserver/nginx/vhost/www.conf<br />\n 修改 fastcgi_pass 127.0.0.1:9000; 为 fastcgi_pass unix:/tmp/php-cgi.sock;</p>\n</blockquote>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">## 部分配置</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>location ~ /<span class=\"token punctuation\">(</span>.+<span class=\"token punctuation\">\\</span>.php<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>/.+<span class=\"token punctuation\">)</span>*$ <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token comment\"># try_files $uri =404;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token comment\"># rewrite /(.+\\.php)(/.+)*$ /hello.html last;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token comment\"># try_files $uri =404;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        client_max_body_size 10m<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        fastcgi_pass_header Authorization<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        fastcgi_split_path_info ^<span class=\"token punctuation\">(</span>.+<span class=\"token punctuation\">\\</span>.php<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>/.+<span class=\"token punctuation\">)</span>$<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        fastcgi_pass unix:/tmp/php-cgi.sock<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        fastcgi_index index.php<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        include fastcgi_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        fastcgi_param SCRIPT_FILENAME <span class=\"token variable\">$document_root</span><span class=\"token variable\">$fastcgi_script_name</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token comment\"># fastcgi_param SCRIPT_FILENAME /var/www/html$fastcgi_script_name;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        fastcgi_param PATH_INFO <span class=\"token variable\">$fastcgi_path_info</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        fastcgi_param PHP_ADMIN_VALUE <span class=\"token string\">\"open_basedir=<span class=\"token variable\">$document_root</span>/../:/tmp/:/proc/\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><blockquote>\n<p>配置完成后重启 nginx</p>\n</blockquote>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>/usr/local/webserver/nginx/sbin/nginx -s reopen</pre></td></tr></table></figure>",
            "tags": [
                "Linux",
                "教程",
                "Linux",
                "PHP"
            ]
        },
        {
            "id": "https://ambercc.gitee.io/linux/linux-nginx-install/",
            "url": "https://ambercc.gitee.io/linux/linux-nginx-install/",
            "title": "Centos下安装nginx",
            "date_published": "2022-06-20T07:21:37.000Z",
            "content_html": "<h2 id=\"参考链接\"><a class=\"anchor\" href=\"#参考链接\">#</a> 参考链接</h2>\n<ul>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cucnVub29iLmNvbS9saW51eC9uZ2lueC1pbnN0YWxsLXNldHVwLmh0bWw=\">https://www.runoob.com/linux/nginx-install-setup.html</span></li>\n</ul>\n<h2 id=\"安装过程\"><a class=\"anchor\" href=\"#安装过程\">#</a> 安装过程</h2>\n<h3 id=\"安装依赖\"><a class=\"anchor\" href=\"#安装依赖\">#</a> 安装依赖</h3>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>yum -y <span class=\"token function\">install</span> <span class=\"token function\">make</span> zlib zlib-devel gcc-c++ libtool  openssl openssl-devel</pre></td></tr></table></figure><h3 id=\"安装pcre\"><a class=\"anchor\" href=\"#安装pcre\">#</a> 安装 pcre</h3>\n<p>PCRE 作用是让 Nginx 支持 Rewrite 功能。</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">cd</span> /usr/local/src/</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">wget</span> http://downloads.sourceforge.net/project/pcre/pcre/8.35/pcre-8.35.tar.gz</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">tar</span> zxvf pcre-8.35.tar.gz</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token builtin class-name\">cd</span> pcre-8.35</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>./configure</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token function\">make</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">make</span> <span class=\"token function\">install</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">## 查看版本判断是否安装成功</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>pcre-config --version</pre></td></tr></table></figure><h3 id=\"安装nginx\"><a class=\"anchor\" href=\"#安装nginx\">#</a> 安装 nginx</h3>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">cd</span> /usr/local/src/</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sudo</span> -s <span class=\"token function\">wget</span> http://nginx.org/download/nginx-1.8.0.tar.gz</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">tar</span> zxvf nginx-1.8.0.tar.gz</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token builtin class-name\">cd</span> nginx-1.8.0</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>./configure --prefix<span class=\"token operator\">=</span>/usr/local/webserver/nginx --with-http_stub_status_module --with-http_ssl_module --with-pcre<span class=\"token operator\">=</span>/usr/local/src/pcre-8.35</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">## 查看版本判断是否安装成功</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>/usr/local/webserver/nginx/sbin/nginx -v</pre></td></tr></table></figure><h2 id=\"nginx配置\"><a class=\"anchor\" href=\"#nginx配置\">#</a> nginx 配置</h2>\n<h3 id=\"设置环境变量\"><a class=\"anchor\" href=\"#设置环境变量\">#</a> 设置环境变量</h3>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">vi</span> /etc/profile</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#行尾加上如下</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token builtin class-name\">export</span>  <span class=\"token assign-left variable\"><span class=\"token environment constant\">PATH</span></span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token environment constant\">$PATH</span>:/usr/local/webserver/nginx/sbin\"</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token builtin class-name\">source</span> /etc/profile</pre></td></tr></table></figure><h3 id=\"创建-nginx-运行使用的用户-www\"><a class=\"anchor\" href=\"#创建-nginx-运行使用的用户-www\">#</a> 创建 Nginx 运行使用的用户 www</h3>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>/usr/sbin/groupadd www</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>/usr/sbin/useradd -g www www</pre></td></tr></table></figure><h3 id=\"配置文件部分\"><a class=\"anchor\" href=\"#配置文件部分\">#</a> 配置文件 (部分)</h3>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">cat</span> /usr/local/webserver/nginx/conf/nginx.conf</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">####################################################################################</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>http<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>user www www<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>worker_processes auto<span class=\"token punctuation\">;</span> <span class=\"token comment\">#设置值和 CPU 核心数一致</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>error_log /usr/local/webserver/nginx/logs/nginx_error.log crit<span class=\"token punctuation\">;</span> <span class=\"token comment\">#日志位置和日志级别</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>pid /usr/local/webserver/nginx/nginx.pid<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">#Specifies the value for maximum file descriptors that can be opened by this process.</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>worker_rlimit_nofile <span class=\"token number\">65535</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>events</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  use epoll<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  worker_connections <span class=\"token number\">65535</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\">#vhost </span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>include vhosts/*.conf<span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><blockquote>\n<p>vhost 配置，例：我的 php tp5 框架 常用配置<br />\n /usr/local/webserver/nginx/conf/vhost/app.conf</p>\n</blockquote>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    listen <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    server_name  _<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    root   /data/www/om/public<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    index  index.php index.html index.htm<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token function\">gzip</span>  on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    gzip_min_length  1k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    gzip_buffers     <span class=\"token number\">4</span> 16k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    gzip_http_version <span class=\"token number\">1.1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    gzip_comp_level <span class=\"token number\">9</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    gzip_types       text/plain application/x-javascript text/css application/xml text/javascript application/x-httpd-php application/javascript application/json<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    gzip_disable <span class=\"token string\">\"MSIE [1-6]\\.\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    gzip_vary on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    location / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                <span class=\"token comment\">#主要是这一段一定要确保存在</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>-e <span class=\"token variable\">$request_filename</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                    rewrite  ^<span class=\"token punctuation\">(</span>.*<span class=\"token punctuation\">)</span>$  /index.php?s<span class=\"token operator\">=</span>/<span class=\"token variable\">$1</span>  last<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                    <span class=\"token builtin class-name\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                <span class=\"token comment\">#结束</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                <span class=\"token comment\">#autoindex  on;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    location ~ /<span class=\"token punctuation\">(</span>.+<span class=\"token punctuation\">\\</span>.php<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>/.+<span class=\"token punctuation\">)</span>*$ <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token comment\"># try_files $uri =404;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token comment\"># rewrite /(.+\\.php)(/.+)*$ /hello.html last;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token comment\"># try_files $uri =404;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        client_max_body_size 10m<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        fastcgi_pass_header Authorization<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        fastcgi_split_path_info ^<span class=\"token punctuation\">(</span>.+<span class=\"token punctuation\">\\</span>.php<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>/.+<span class=\"token punctuation\">)</span>$<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        fastcgi_pass <span class=\"token number\">127.0</span>.0.1:9000<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        fastcgi_index index.php<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        include fastcgi_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        fastcgi_param SCRIPT_FILENAME <span class=\"token variable\">$document_root</span><span class=\"token variable\">$fastcgi_script_name</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token comment\"># fastcgi_param SCRIPT_FILENAME /var/www/html$fastcgi_script_name;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        fastcgi_param PATH_INFO <span class=\"token variable\">$fastcgi_path_info</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        fastcgi_param PHP_ADMIN_VALUE <span class=\"token string\">\"open_basedir=<span class=\"token variable\">$document_root</span>/../:/tmp/:/proc/\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    location ~ .*<span class=\"token punctuation\">\\</span>.<span class=\"token punctuation\">(</span>gif<span class=\"token operator\">|</span>jpg<span class=\"token operator\">|</span>jpeg<span class=\"token operator\">|</span>png<span class=\"token operator\">|</span>bmp<span class=\"token operator\">|</span>swf<span class=\"token operator\">|</span>flv<span class=\"token operator\">|</span>mp4<span class=\"token operator\">|</span>ico<span class=\"token punctuation\">)</span>$</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>          <span class=\"token comment\">#允许跨域请求</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>          add_header Access-Control-Allow-Origin <span class=\"token string\">'*'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          add_header Access-Control-Allow-Headers X-Requested-With<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>          add_header Access-Control-Allow-Methods GET,POST,OPTIONS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>          expires 30d<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>          access_log off<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure>",
            "tags": [
                "Linux",
                "教程",
                "Linux"
            ]
        },
        {
            "id": "https://ambercc.gitee.io/python-asyncio-eventloop/",
            "url": "https://ambercc.gitee.io/python-asyncio-eventloop/",
            "title": "Python Asyncio EventLoop 个人理解",
            "date_published": "2022-05-12T08:01:51.000Z",
            "content_html": "<h2 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h2>\n<blockquote>\n<p>之前尝试用 python 的 telethon 开发时，由于不太了解 python 遇到不少坑<br />\n幸运的是通过 Google 从前人哪里找到了解决办法<br />\n其中一个问题让我影响深刻，为了弄清楚为什么，我又回头了解 asyncio eventLoop<br />\n 这个过程让我更加了解 python</p>\n</blockquote>\n<h2 id=\"runtimeerror-there-is-no-current-event-loop-in-thread-thread-1\"><a class=\"anchor\" href=\"#runtimeerror-there-is-no-current-event-loop-in-thread-thread-1\">#</a> RuntimeError: There is no current event loop in thread 'Thread-1'.</h2>\n<blockquote>\n<p>意思是线程中没有当前事件循环<br />\n字我都认识，但是组合起来后，没看懂什么意思<br />\n不过幸好找到了解决办法，加上下面的两行代码就行，顺利解决了<br />\n不过虽然解决了，但我还是不知道为什么，于是便抽空仔细阅读了关于 asyncio 的内容</p>\n</blockquote>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>new_loop <span class=\"token operator\">=</span> asyncio.new_event_loop<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>asyncio.set_event_loop<span class=\"token punctuation\">(</span>new_loop<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h3 id=\"参考地址\"><a class=\"anchor\" href=\"#参考地址\">#</a> 参考地址</h3>\n<ul>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTM0MjE2MjkvYXJ0aWNsZS9kZXRhaWxzLzEwMDE2MzAxNA==\">https://blog.csdn.net/u013421629/article/details/100163014</span> (解决办法)</li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvNTEzMTEzODMvcHl0aG9uLWZsYXNrLXdpdGgtdGVsZXRob24=\">https://stackoverflow.com/questions/51311383/python-flask-with-telethon</span> (里面说和 asyncio 有关)</li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0MzQxNDIzL2FydGljbGUvZGV0YWlscy8xMDI4NzQyNjM=\">https://blog.csdn.net/qq_34341423/article/details/102874263</span> (eventLoop 的使用)</li>\n</ul>\n<h2 id=\"探究过程\"><a class=\"anchor\" href=\"#探究过程\">#</a> 探究过程</h2>\n<blockquote>\n<p>之前有看到关于 EventLoop 的介绍，但是没心思看下去<br />\n自己遇到的了问题，才有探究的动力<br />\n于是我试着通过代码了解它</p>\n</blockquote>\n<h3 id=\"首先写一段代码-简单了解-asyncio-eventloop\"><a class=\"anchor\" href=\"#首先写一段代码-简单了解-asyncio-eventloop\">#</a> 首先写一段代码 简单了解 asyncio eventLoop</h3>\n<p>文件名 <span class=\"exturl\" data-url=\"aHR0cDovL3Rlc3QucHk=\">test.py</span></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">import</span> asyncio</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>async def coroutine_example<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    await asyncio.sleep<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    print<span class=\"token punctuation\">(</span><span class=\"token string\">'task'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">if</span> __name__ <span class=\"token operator\">==</span> <span class=\"token string\">'__main__'</span><span class=\"token builtin class-name\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    coro <span class=\"token operator\">=</span> coroutine_example<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    loop <span class=\"token operator\">=</span> asyncio.get_event_loop<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    loop.run_until_complete<span class=\"token punctuation\">(</span>coro<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    loop.close<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><blockquote>\n<p>async await 很熟悉的异步语法糖<br />\n测试过程中发现 必须加入 run_until_complete 才能执行，直接执行就会提示错误</p>\n</blockquote>\n<h3 id=\"在线程thread中执行eventloop\"><a class=\"anchor\" href=\"#在线程thread中执行eventloop\">#</a> 在线程 (thread) 中执行 EventLoop</h3>\n<blockquote>\n<p>在阅读文章时，看到这么一句话<br />\n get_event_loop () 只会在主线程帮您创建新的 event loop，而在其他线程中调用 get_event_loop () 则会报错<br />\n结合之前遇到的问题，所以是因为在线程中执行 EventLoop，引发了错误<br />\n写了个简单的关于线程代码，并调用 EventLoop<br />\n 通过注释，新建 eventLoop 部分代码，验证了非主线程没有 EventLoop<br />\npython3.7 以后 asyncio.run (coroutine_example ()) 就能代替上面 4 行代码的效果</p>\n</blockquote>\n<p>文件名 <span class=\"exturl\" data-url=\"aHR0cDovL3RocmVhZC5weQ==\">thread.py</span></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">import</span> asyncio</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">import</span> <span class=\"token function\">time</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>from threading <span class=\"token function\">import</span> Thread</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>from <span class=\"token builtin class-name\">test</span> <span class=\"token function\">import</span> coroutine_example</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>def func<span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span>:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    print<span class=\"token punctuation\">(</span>f<span class=\"token string\">\"&#123;name&#125;开始\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    time.sleep<span class=\"token punctuation\">(</span><span class=\"token number\">0.5</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    print<span class=\"token punctuation\">(</span>f<span class=\"token string\">\"&#123;name&#125;结束\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token comment\">#新建 eventLoop</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    new_loop <span class=\"token operator\">=</span> asyncio.new_event_loop<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    asyncio.set_event_loop<span class=\"token punctuation\">(</span>new_loop<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token comment\">#执行异步方法</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    loop <span class=\"token operator\">=</span> asyncio.get_event_loop<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    loop.run_until_complete<span class=\"token punctuation\">(</span>coroutine_example<span class=\"token punctuation\">(</span><span class=\"token punctuation\">))</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token comment\"># asyncio.run(coroutine_example())</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre> </pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token keyword\">if</span> __name__ <span class=\"token operator\">==</span> <span class=\"token string\">'__main__'</span><span class=\"token builtin class-name\">:</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    t1 <span class=\"token operator\">=</span> Thread<span class=\"token punctuation\">(</span>target<span class=\"token operator\">=</span>func, <span class=\"token assign-left variable\">args</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"线程1\"</span>,<span class=\"token punctuation\">))</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    t2 <span class=\"token operator\">=</span> Thread<span class=\"token punctuation\">(</span>target<span class=\"token operator\">=</span>func, <span class=\"token assign-left variable\">args</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"线程2\"</span>,<span class=\"token punctuation\">))</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    t1.start<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    t2.start<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    print<span class=\"token punctuation\">(</span><span class=\"token string\">\"主线程结束\"</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h2 id=\"个人理解总结\"><a class=\"anchor\" href=\"#个人理解总结\">#</a> 个人理解总结</h2>\n<blockquote>\n<p>python async 异步 需要通过 loop.run_until_complete 启动<br />\n默认主线程有 eventLoop，可以直接 get_event_loop<br />\n 其他线程执行 async 异步，需要新创建 eventLoop, new_event_loop 后才能获取 get_event_loop，不然会提示错误<br />\n python3.7 以后， asyncio.run 以更简洁代码的启动 async</p>\n</blockquote>\n",
            "tags": [
                "python",
                "python"
            ]
        },
        {
            "id": "https://ambercc.gitee.io/linux/php-open-basedir/",
            "url": "https://ambercc.gitee.io/linux/php-open-basedir/",
            "title": "php项目部署时踩坑(open_basedir等)",
            "date_published": "2022-04-24T03:42:52.000Z",
            "content_html": "<h2 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h2>\n<blockquote>\n<p>之前用宝塔部署 php TP5 项目时，明明已经安装过了，但总是自动跳转到 install.php<br />\n 于是关掉 open_basedir 就可以了（当时也不求甚解）<br />\n再后来生产环境部署时，又碰上这个问题，这里记录下部署时踩坑</p>\n</blockquote>\n<h2 id=\"参考文章\"><a class=\"anchor\" href=\"#参考文章\">#</a> 参考文章</h2>\n<ul>\n<li><span class=\"exturl\" data-url=\"aHR0cDovL3d3dy44ODQzNTguY29tL29wZW5fYmFzZWRpci8=\">http://www.884358.com/open_basedir/</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9hc2suZmFzdGFkbWluLm5ldC9xdWVzdGlvbi8yOTkyNS5odG1s\">https://ask.fastadmin.net/question/29925.html</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9hc2suZmFzdGFkbWluLm5ldC9xdWVzdGlvbi8xOTYyLmh0bWw=\">https://ask.fastadmin.net/question/1962.html</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9hc2suZmFzdGFkbWluLm5ldC9hcnRpY2xlLzMyMi5odG1s\">https://ask.fastadmin.net/article/322.html</span></li>\n</ul>\n<h2 id=\"open_basedir\"><a class=\"anchor\" href=\"#open_basedir\">#</a> open_basedir</h2>\n<h3 id=\"概述\"><a class=\"anchor\" href=\"#概述\">#</a> 概述</h3>\n<blockquote>\n<p>通过设置 open_basedir 将 PHP 所能打开的文件限制在指定的目录树，包括文件本身。本指令不受安全模式打开或者关闭的影响。<br />\n当一个脚本试图打开一个文件时，该文件的位置将被检查。<br />\n当文件在指定的目录树之外时 PHP 将拒绝打开它。</p>\n</blockquote>\n<div class=\"note info\">\n<p>特别是当服务器上有多个网站时，非常有必要设置 open_basedir，防止黑客跨站攻击。</p>\n</div>\n<h3 id=\"解决办法\"><a class=\"anchor\" href=\"#解决办法\">#</a> 解决办法</h3>\n<blockquote>\n<p>修改配置 open_basedir （我的默认位置 /usr/local/nginx/conf/fastcgi.conf，具体看个人情况）<br />\n测试环境或者直接禁用</p>\n</blockquote>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#注意 $document_root 的参数是由 root html 那一行定义的，而 TP5 默认都是 root 根目录 /public</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>fastcgi_param PHP_ADMIN_VALUE \"open_basedir=$document_root/../<span class=\"token punctuation\">:</span>/tmp/<span class=\"token punctuation\">:</span>/proc/\";</pre></td></tr></table></figure><h2 id=\"权限问题\"><a class=\"anchor\" href=\"#权限问题\">#</a> 权限问题</h2>\n<blockquote>\n<p>如 runtime uploads 等目录会因为权限不够造成启动或上传文件失败<br />\n直接修改对应文件夹权限 或修改整个项目的权限组 如与 php nginx 相同的 www:www</p>\n</blockquote>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">chown</span> -R 所有者:所属组 文件或目录</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#或者</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">chmod</span> -R <span class=\"token number\">777</span> 文件或目录</pre></td></tr></table></figure><h2 id=\"php上传文件常见配置修改\"><a class=\"anchor\" href=\"#php上传文件常见配置修改\">#</a> php 上传文件常见配置修改</h2>\n<blockquote>\n<p>php.ini</p>\n</blockquote>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#设置了在强制终止脚本前 PHP 等待脚本执行完毕的时间 如果上传视频等耗时长的大文件可以设置长的或者 set_time_limit (0);</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>max_execution_time</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">#允许通过 HTTP 进行文件上传</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>file_uploads = On 默认值为on</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">#设定文件上传的大小的最大值</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>upload_max_filesize = 20M</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">#限制的是客户端通过 POST 方法进行一次表单提交时 PHP 程序所能够接收的最大数据量 此值的值设置的比 upload_max_filesize 略大即可</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>post_max_size = 21M</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">#此变量可以以秒为单位对通过 POST、GET 以及 PUT 方式接收数据时间进行限制</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>max_input_time = 90</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">#PHP 允许定义内存使用限额 也必须足够大</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>memory_limit = 128M</pre></td></tr></table></figure><blockquote>\n<p>nginx<br />\n 默认路径（看个人安装） /usr/local/nginx/conf/nginx.conf</p>\n</blockquote>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#在 nginx 的配置文件里面加上 或者在自己的 server 内</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>client_max_body_size 20m</pre></td></tr></table></figure>",
            "tags": [
                "Linux",
                "PHP"
            ]
        },
        {
            "id": "https://ambercc.gitee.io/linux/linux-php-install/",
            "url": "https://ambercc.gitee.io/linux/linux-php-install/",
            "title": "Centos下安装php7.1",
            "date_published": "2022-04-15T02:56:00.000Z",
            "content_html": "<h2 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h2>\n<p>之前都是用集成环境或者 docker 安装 php 环境<br />\n没有正儿八经的在 linux 下安装 php<br />\n 这里记录下安装过程</p>\n<h2 id=\"参考文章\"><a class=\"anchor\" href=\"#参考文章\">#</a> 参考文章</h2>\n<ul>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8yOTU5OTI0NS9hcnRpY2xlL2RldGFpbHMvMTE1MTI1NzQ3\">https://blog.csdn.net/weixin_29599245/article/details/115125747</span></li>\n</ul>\n<h2 id=\"安装过程\"><a class=\"anchor\" href=\"#安装过程\">#</a> 安装过程</h2>\n<h3 id=\"下载解压源码包\"><a class=\"anchor\" href=\"#下载解压源码包\">#</a> 下载解压源码包</h3>\n<blockquote>\n<p>根据个人需要下载版本</p>\n</blockquote>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">wget</span> https://www.php.net/distributions/php-7.1.33.tar.gz</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">tar</span> -xzvf php-7.1.33.tar.gz</pre></td></tr></table></figure><h3 id=\"安装所需环境\"><a class=\"anchor\" href=\"#安装所需环境\">#</a> 安装所需环境</h3>\n<blockquote>\n<p>php 时安装需要一些工具包、拓展等<br />\n下面列出了一些可能用到的<br />\n安装成功后 默认路径在 /usr/include</p>\n</blockquote>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>yum <span class=\"token function\">install</span> -y gcc gcc-c++ <span class=\"token function\">make</span> zlib zlib-devel pcre pcre-devel libjpeg libjpeg-devel libpng libpng-devel freetype freetype-devel libxml2 libxml2-devel glibc glibc-devel glib2 glib2-devel <span class=\"token function\">bzip2</span> bzip2-devel ncurses ncurses-devel <span class=\"token function\">curl</span> curl-devel e2fsprogs e2fsprogs-devel krb5 krb5-devel openssl openssl-devel openldap openldap-devel nss_ldap openldap-clients openldap-servers</pre></td></tr></table></figure><blockquote>\n<p>也可以安装通过源码包手动安装<br />\n指定安装路径<br />\n比如安装 freetype-2.10.1</p>\n</blockquote>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#下载 解压 freetype-2.10.1</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token builtin class-name\">cd</span> freetype-2.10.1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>./configure --prefix<span class=\"token operator\">=</span>/usr/local/freetype</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">make</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">make</span> <span class=\"token function\">install</span></pre></td></tr></table></figure><h3 id=\"php安装位置配置以及启用拓展\"><a class=\"anchor\" href=\"#php安装位置配置以及启用拓展\">#</a> php 安装位置配置以及启用拓展</h3>\n<blockquote>\n<p>--prefix=/usr/local/php 指定我的 php 安装配置<br />\n根据个人情况修改自己的安装路径<br />\n根据需要，启用拓展，有些开启就行，有些拓展需要指定安装路径<br />\n注：启用 gd 拓展，需要开启 freetype 等，不然图片验证码不可用</p>\n</blockquote>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#进入安装路径</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token builtin class-name\">cd</span> php-7.1.33</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">#配置启用拓展</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>./configure --prefix<span class=\"token operator\">=</span>/usr/local/php --exec-prefix<span class=\"token operator\">=</span>/usr/local/php --with-mysqli --with-pdo-mysql --with-gd --bindir<span class=\"token operator\">=</span>/usr/local/php/bin --sbindir<span class=\"token operator\">=</span>/usr/local/php/sbin --includedir<span class=\"token operator\">=</span>/usr/local/php/include --libdir<span class=\"token operator\">=</span>/usr/local/php/lib/php --mandir<span class=\"token operator\">=</span>/usr/local/php/php/man --with-config-file-path<span class=\"token operator\">=</span>/usr/local/php/etc --with-openssl --enable-mbstring --enable-fpm --enable-bcmath --enable-pcntl --enable-zip  --with-freetype-dir<span class=\"token operator\">=</span>/usr/include/freetype2/freetype --with-jpeg-dir<span class=\"token operator\">=</span>/usr/include/ --with-png-dir<span class=\"token operator\">=</span>/usr/include --with-curl<span class=\"token operator\">=</span>/usr/include --with-zlib<span class=\"token operator\">=</span>/usr/include</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">#编译并安装</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token function\">make</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">make</span> <span class=\"token function\">install</span></pre></td></tr></table></figure><div class=\"note danger\">\n<p>踩坑<br />\n通过 yum install -y freetype freetype-devel 安装的 freetype php 配置如下<br />\n --with-freetype-dir=/usr/include/freetype2/freetype</p>\n<p>手动安装拓展 php 配置如下<br />\n --with-freetype-dir=/usr/local/freetype</p>\n</div>\n<div class=\"note info\">\n<p>关于 zip<br />\nphp7.4 开始 捆绑的 libzip 已被移除，编译时使用 --with-zip<br />\n 之前的 php 版本可用 --enable-zip 开启 zip</p>\n</div>\n<h3 id=\"配置php使用\"><a class=\"anchor\" href=\"#配置php使用\">#</a> 配置 PHP 使用</h3>\n<ul>\n<li>拷贝配置文件</li>\n</ul>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#拷贝 php 配置文件</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">cp</span> php.ini-production /usr/local/php/etc/php.ini</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#拷贝 php-fpm 服务并赋予执行权限</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">cp</span> sapi/fpm/init.d.php-fpm /etc/init.d/php-fpm</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token function\">chmod</span> +x /etc/init.d/php-fpm</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># 拷贝 php-fpm 进程服务的配置文件和扩展配置文件</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token function\">cp</span> /usr/local/php/etc/php-fpm.conf.default /usr/local/php/etc/php-fpm.conf</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token function\">cp</span> /usr/local/php/etc/php-fpm.d/www.conf.default /usr/local/php/etc/php-fpm.d/www.conf</pre></td></tr></table></figure><ul>\n<li>配置环境变量</li>\n</ul>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 配置安装目录 (可选)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">vi</span> /usr/local/php/etc/php-fpm.conf</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># php-fpm.conf 最后一行，include 的路径要对应于自己的安装目录 shift + g 跳最后一行 ，gg 第一行</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">include</span><span class=\"token operator\">=</span>/usr/local/php/etc/php-fpm.d/*.conf</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># 设置 php 环境变量</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token function\">vi</span> /etc/profile.d/php.sh</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\"><span class=\"token environment constant\">PATH</span></span><span class=\"token operator\">=</span><span class=\"token environment constant\">$PATH</span>:/usr/local/php/bin/:/usr/local/php/sbin/</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># 生效环境变量</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token builtin class-name\">source</span> /etc/profile.d/php.sh</pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># 测试成功</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>php -v</pre></td></tr></table></figure><ul>\n<li>启动 php-fpm</li>\n</ul>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#启动 php-fpm</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">service</span> php-fpm start</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 设置 php-fpm 开机启动</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">chkconfig</span> php-fpm on</pre></td></tr></table></figure><h3 id=\"nginx和php\"><a class=\"anchor\" href=\"#nginx和php\">#</a> nginx 和 php</h3>\n<blockquote>\n<p>确保启动 PHP 和 NGINX 的用户和用户组一致，这样可避免一些访问权限问题<br />\n php 的配置文件 /usr/local/php/etc/php-fpm.d/www.conf 的 user、group 修改为和 nginx 相同的用户和用户组<br />\n nginx 的 nginx.conf 中的 use 使用的用户，一般在该配置文件头</p>\n</blockquote>\n",
            "tags": [
                "Linux",
                "教程",
                "Linux",
                "PHP"
            ]
        },
        {
            "id": "https://ambercc.gitee.io/linux/dockerfile-php/",
            "url": "https://ambercc.gitee.io/linux/dockerfile-php/",
            "title": "Dockerfile构建FastAdmin的php环境",
            "date_published": "2022-04-15T02:54:06.000Z",
            "content_html": "<h2 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h2>\n<p>记录下自己 docker 下常用的 php 环境构建，可以上传的 docker 镜像仓库<br />\n因为构建还挺耗时的</p>\n<h2 id=\"具体代码\"><a class=\"anchor\" href=\"#具体代码\">#</a> 具体代码</h2>\n<figure class=\"highlight dockerfile\"><figcaption data-lang=\"Docker\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token instruction\"><span class=\"token keyword\">FROM</span> php:7.1.13-fpm</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token instruction\"><span class=\"token keyword\">RUN</span> echo <span class=\"token string\">\"deb http://mirrors.aliyun.com/debian/ stretch main non-free contrib\"</span> > /etc/apt/sources.list <span class=\"token operator\">\\</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    &amp;&amp; echo <span class=\"token string\">\"deb-src http://mirrors.aliyun.com/debian/ stretch main non-free contrib\"</span> >> /etc/apt/sources.list <span class=\"token operator\">\\</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    &amp;&amp; echo <span class=\"token string\">\"deb http://mirrors.aliyun.com/debian-security stretch/updates main\"</span> >> /etc/apt/sources.list <span class=\"token operator\">\\</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    &amp;&amp; echo <span class=\"token string\">\"deb-src http://mirrors.aliyun.com/debian-security stretch/updates main\"</span> >> /etc/apt/sources.list <span class=\"token operator\">\\</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    &amp;&amp; echo <span class=\"token string\">\"deb http://mirrors.aliyun.com/debian/ stretch-updates main non-free contrib\"</span> >> /etc/apt/sources.list <span class=\"token operator\">\\</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    &amp;&amp; echo <span class=\"token string\">\"deb-src http://mirrors.aliyun.com/debian/ stretch-updates main non-free contrib\"</span> >> /etc/apt/sources.list <span class=\"token operator\">\\</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    &amp;&amp; echo <span class=\"token string\">\"deb http://mirrors.aliyun.com/debian/ stretch-backports main non-free contrib\"</span> >> /etc/apt/sources.list <span class=\"token operator\">\\</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    &amp;&amp; echo <span class=\"token string\">\"deb-src http://mirrors.aliyun.com/debian/ stretch-backports main non-free contrib\"</span> >> /etc/apt/sources.list <span class=\"token operator\">\\</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    &amp;&amp; rm -f /etc/apt/sources.list.d/* <span class=\"token operator\">\\</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    &amp;&amp; docker-php-ext-install pdo_mysql mysqli <span class=\"token operator\">\\</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    &amp;&amp; apt-get update &amp;&amp; apt-get install -y <span class=\"token operator\">\\</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        libfreetype6-dev <span class=\"token operator\">\\</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        libjpeg62-turbo-dev <span class=\"token operator\">\\</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        libpng-dev <span class=\"token operator\">\\</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        pkg-config <span class=\"token operator\">\\</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        libssl-dev <span class=\"token operator\">\\</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    &amp;&amp; docker-php-ext-configure gd --with-freetype-dir=/usr/include/ --with-jpeg-dir=/usr/include/ --with-png-dir=/usr/include <span class=\"token operator\">\\</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    &amp;&amp; docker-php-ext-install -j$(nproc) gd pcntl bcmath</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token instruction\"><span class=\"token keyword\">RUN</span> pecl install https://pecl.php.net/get/swoole-4.5.10.tgz <span class=\"token operator\">\\</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    &amp;&amp; pecl install redis <span class=\"token operator\">\\</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    &amp;&amp; pecl install mongodb <span class=\"token operator\">\\</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    &amp;&amp; docker-php-ext-enable swoole redis mongodb</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token instruction\"><span class=\"token keyword\">CMD</span> [<span class=\"token string\">\"php-fpm\"</span>]</span></pre></td></tr></table></figure>",
            "tags": [
                "Linux",
                "教程",
                "Linux",
                "PHP"
            ]
        },
        {
            "id": "https://ambercc.gitee.io/image-hosting/",
            "url": "https://ambercc.gitee.io/image-hosting/",
            "title": "在线图床PicX - 基于git+jsDelivr作为个人图床",
            "date_published": "2022-02-25T07:49:51.000Z",
            "content_html": "<h2 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h2>\n<blockquote>\n<p>用 hexo 写文章突然发现要上传几张截图，放到项目里也不合适<br />\n正好在 github 上看到一个项目 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL1hQb2V0L3BpY3g=\">PicX 图床 - 基于 GitHub API &amp; jsDelivr</span><br />\n 提供接口，把图片存储在自己公开的 github 仓库里，jsDelivr 加速</p>\n</blockquote>\n<h2 id=\"在线使用入口\"><a class=\"anchor\" href=\"#在线使用入口\">#</a> 在线使用入口</h2>\n<blockquote>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9waWN4Lnhwb2V0LmNu\">入口</span></p>\n</blockquote>\n<h3 id=\"准备一个公共仓库\"><a class=\"anchor\" href=\"#准备一个公共仓库\">#</a> 准备一个公共仓库</h3>\n<h3 id=\"准备一个带有-repo-权限的-github-token\"><a class=\"anchor\" href=\"#准备一个带有-repo-权限的-github-token\">#</a> 准备一个带有 repo 权限的 GitHub Token</h3>\n<blockquote>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3NldHRpbmdzL3Rva2Vucy9uZXc=\">快速新建 Token</span></p>\n</blockquote>\n<h2 id=\"官方文档\"><a class=\"anchor\" href=\"#官方文档\">#</a> 官方文档</h2>\n<blockquote>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9waWN4LWRvY3MueHBvZXQuY24=\">跳转地址</span></p>\n</blockquote>\n",
            "tags": [
                "教程",
                "教程"
            ]
        },
        {
            "id": "https://ambercc.gitee.io/pm2-node-unlimit-restart/",
            "url": "https://ambercc.gitee.io/pm2-node-unlimit-restart/",
            "title": "pm2启动node项目无限重启",
            "date_published": "2022-01-25T12:24:16.000Z",
            "content_html": "<h2 id=\"说明\"><a class=\"anchor\" href=\"#说明\">#</a> 说明</h2>\n<blockquote>\n<p>用 node 写了一个机器人，开发时都是用 node 启动，并没有什么问题<br />\n用 pm2 启动后，项目一直重启<br />\n定位是由于 fs.writeFileSync 写入文件导致的<br />\n由于 pm2 策略，若文件变动，则重启项目</p>\n</blockquote>\n<h2 id=\"解决办法\"><a class=\"anchor\" href=\"#解决办法\">#</a> 解决办法</h2>\n<blockquote>\n<p>修改 ecosystem.config.js 配置</p>\n</blockquote>\n<figure class=\"highlight javascript\"><figcaption data-lang=\"javascript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 把变动的文件加入 ignore_watch </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>ignore_watch <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"data.json\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">// 或者关闭自动重启</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>autorestart<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">// 或者关闭 watch</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>watch<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span></pre></td></tr></table></figure>",
            "tags": [
                "node",
                "教程",
                "node"
            ]
        },
        {
            "id": "https://ambercc.gitee.io/linux/vbox-v2rayn-proxy/",
            "url": "https://ambercc.gitee.io/linux/vbox-v2rayn-proxy/",
            "title": "vbox虚拟机ubuntu使用代理配合v2rayN",
            "date_published": "2022-01-25T11:53:06.000Z",
            "content_html": "<h2 id=\"说明\"><a class=\"anchor\" href=\"#说明\">#</a> 说明</h2>\n<blockquote>\n<p>因为本地主机都是用 v2rayN 翻墙，开发外网 API 也利用它的作为 http 代理<br />\n这里记录下，vbox 虚拟机作为运行环境时，也能用代理</p>\n</blockquote>\n<h2 id=\"踩坑\"><a class=\"anchor\" href=\"#踩坑\">#</a> 踩坑</h2>\n<blockquote>\n<p>v2rayN 顶部菜单有 设置 》 参数数组 》 v2rayN 设置 勾选 允许来自局域网的连接</p>\n</blockquote>\n<h2 id=\"配置\"><a class=\"anchor\" href=\"#配置\">#</a> 配置</h2>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 编辑</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">vi</span> /etc/profile</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">#最后一行加上 (proxy_ip:port proxy_ip 是本地主机 port 是 v2rayN 的 http 代理端口，)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">http_proxy</span><span class=\"token operator\">=</span>http://proxy_ip:port     <span class=\"token comment\">#代表 http 代理</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">#添加后执行</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token builtin class-name\">source</span> /etc/profile</pre></td></tr></table></figure><h2 id=\"测试\"><a class=\"anchor\" href=\"#测试\">#</a> 测试</h2>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">curl</span> www.google.com</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#或者</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">wget</span> www.google.com</pre></td></tr></table></figure><h2 id=\"取消代理-命令\"><a class=\"anchor\" href=\"#取消代理-命令\">#</a> 取消代理 命令</h2>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">unset</span> http_proxy</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token builtin class-name\">unset</span> https_proxy</pre></td></tr></table></figure>",
            "tags": [
                "Linux",
                "教程",
                "Linux"
            ]
        },
        {
            "id": "https://ambercc.gitee.io/node-java-urlencode/",
            "url": "https://ambercc.gitee.io/node-java-urlencode/",
            "title": "node和java的urlencode踩坑",
            "date_published": "2022-01-21T06:47:41.000Z",
            "content_html": "<h2 id=\"说明\"><a class=\"anchor\" href=\"#说明\">#</a> 说明</h2>\n<blockquote>\n<p>之前用 node 接入一个 api 的时候，对方用 urlencode 处理验签<br />\n结果总是和对方的 sign 不必配<br />\n对比后发现对方的 urlencode 处理出来的结果和 node 处理的有些差别<br />\n网上查了下 java 的 urlencode 的差异<br />\n这里记录下 node 的处理方法</p>\n</blockquote>\n<h2 id=\"node的处理方法\"><a class=\"anchor\" href=\"#node的处理方法\">#</a> node 的处理方法</h2>\n<figure class=\"highlight javascript\"><figcaption data-lang=\"javascript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">let</span> <span class=\"token function-variable function\">urlEncodeJava</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">string</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>        <span class=\"token comment\">// string → urlCodeStr</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token keyword\">const</span> urlCodeStr <span class=\"token operator\">=</span> <span class=\"token function\">encodeURIComponent</span><span class=\"token punctuation\">(</span>string<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">%20</span><span class=\"token regex-delimiter\">/</span><span class=\"token regex-flags\">gi</span></span><span class=\"token punctuation\">,</span> <span class=\"token string\">'+'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">(!)|(')|(\\()|(\\))|(\\~)</span><span class=\"token regex-delimiter\">/</span><span class=\"token regex-flags\">gi</span></span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">item</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token string\">'%'</span> <span class=\"token operator\">+</span> item<span class=\"token punctuation\">.</span><span class=\"token function\">charCodeAt</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toLocaleUpperCase</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">return</span> urlCodeStr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure>",
            "tags": [
                "node",
                "教程",
                "node"
            ]
        },
        {
            "id": "https://ambercc.gitee.io/linux/linux-mount-windows-share-folder/",
            "url": "https://ambercc.gitee.io/linux/linux-mount-windows-share-folder/",
            "title": "Linux挂载windows共享文件夹",
            "date_published": "2022-01-21T03:33:53.000Z",
            "content_html": "<h2 id=\"说明\"><a class=\"anchor\" href=\"#说明\">#</a> 说明</h2>\n<blockquote>\n<p>本来 Vbox 虚拟机的共享文件夹用的好好的<br />\n因为电脑突然断电，重新挂载共享文件夹后发现，nginx 无法访问共享文件夹的静态文件<br />\n其他目录下，nginx 倒是访问好好的<br />\n始终没找到解决办法<br />\n最后想试试不用 Vbox 的共享文件夹，直接 windows 设置共享后挂载，最后可以访问正常了</p>\n</blockquote>\n<div class=\"note danger\">\n<p>#资源访问报错<br />\n net::ERR_CONTENT_LENGTH_MISMATCH 200 (OK)<br />\n#error log 日志<br />\n [alert] 82080#0: *53 sendfile () failed (22: Invalid argument) while sending response to client,</p>\n</div>\n<h2 id=\"设置windows共享文件夹\"><a class=\"anchor\" href=\"#设置windows共享文件夹\">#</a> 设置 windows 共享文件夹</h2>\n<blockquote>\n<p>选择一个文件夹 [share]，右键 选择属性 弹出属性窗口 选择分页共享<br />\n创建共享，分配权限，可以新建一个用户比如账密为 share, 专门用来访问这个共享文件夹<br />\n成功后路径就是 //ip 地址 /share</p>\n</blockquote>\n<h2 id=\"linux挂载windows共享文件夹\"><a class=\"anchor\" href=\"#linux挂载windows共享文件夹\">#</a> Linux 挂载 windows 共享文件夹</h2>\n<blockquote>\n<p>使用 mount.cifs 来挂载 windows 共享文件夹<br />\n参考链接 <span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20veGlhLXdlaXdlbi9wLzc0MTY2NjYuaHRtbA==\">https://www.cnblogs.com/xia-weiwen/p/7416666.html</span></p>\n</blockquote>\n<h3 id=\"安装依赖\"><a class=\"anchor\" href=\"#安装依赖\">#</a> 安装依赖</h3>\n<blockquote>\n<p>使用 mount.cifs 需要 cifs-utils 软件包（以及 cifs-utils 依赖的软件包）</p>\n</blockquote>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> cifs-utils</pre></td></tr></table></figure><h3 id=\"挂载共享文件夹\"><a class=\"anchor\" href=\"#挂载共享文件夹\">#</a> 挂载共享文件夹</h3>\n<blockquote>\n<p>挂载命令</p>\n</blockquote>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#参考</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sudo</span> mount.cifs //<span class=\"token punctuation\">[</span>address<span class=\"token punctuation\">]</span>/<span class=\"token punctuation\">[</span>folder<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>mount point<span class=\"token punctuation\">]</span> -o <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>username<span class=\"token punctuation\">]</span>,passwd<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>pw<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">#或者</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">mount</span> -t cifs //<span class=\"token punctuation\">[</span>address<span class=\"token punctuation\">]</span>/<span class=\"token punctuation\">[</span>folder<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>mount point<span class=\"token punctuation\">]</span> -o <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>username<span class=\"token punctuation\">]</span>,passwd<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>pw<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># 我的具体命令</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># 先创建挂载点目录</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>sud <span class=\"token function\">mkdir</span> /mnt/www</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">mount</span> -t cifs /mnt/www -o //192.168.0.179/share <span class=\"token assign-left variable\">username</span><span class=\"token operator\">=</span><span class=\"token string\">\"share\"</span>,password<span class=\"token operator\">=</span><span class=\"token string\">\"share\"</span></pre></td></tr></table></figure><blockquote>\n<p>挂载成功后发现，nginx 静态资源能正常访问了 [思考为什么之前 Vbox 的共享文件夹不能访问]<br />\n 不过这样添加后，nginx 访问 php 项目报错 file_put_contents 权限问题，只能读，不能写</p>\n</blockquote>\n<p>以上命令还有一些额外参数</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#参考</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sudo</span> mount.cifs //<span class=\"token punctuation\">[</span>address<span class=\"token punctuation\">]</span>/<span class=\"token punctuation\">[</span>folder<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>mount point<span class=\"token punctuation\">]</span> -o <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>username<span class=\"token punctuation\">]</span>,passwd<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>pw<span class=\"token punctuation\">]</span>,uid<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token environment constant\">UID</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#先卸载原先的挂载</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">umount</span> <span class=\"token punctuation\">[</span>mount point<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># 我需要 www 权限 id 为 1001 也可以设置，dir_mode=0777,file_mode=0777</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token function\">id</span> -u <span class=\"token punctuation\">[</span>username<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">#我的具体命令</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token function\">mount</span> -t cifs //192.168.0.179/share /mnt/www -o <span class=\"token assign-left variable\">username</span><span class=\"token operator\">=</span><span class=\"token string\">\"share\"</span>,password<span class=\"token operator\">=</span><span class=\"token string\">\"share\"</span>,uid<span class=\"token operator\">=</span><span class=\"token number\">1001</span>,dir_mode<span class=\"token operator\">=</span>0777,file_mode<span class=\"token operator\">=</span>0777</pre></td></tr></table></figure><blockquote>\n<p>这样 nginx 下的 php 项目就能正常访问了</p>\n</blockquote>\n<h2 id=\"开机时自动挂载\"><a class=\"anchor\" href=\"#开机时自动挂载\">#</a> 开机时自动挂载</h2>\n<blockquote>\n<p>使用 mount 挂载的方法在系统重新启动后就会失效，如果希望开机时自动挂载<br />\n根据自己的具体清空将下面设置加入 /etc/fstab 文件最后面就可以了。</p>\n</blockquote>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>//192.168.0.179/share /mnt/www cifs defaults,username<span class=\"token operator\">=</span>share,password<span class=\"token operator\">=</span>share,uid<span class=\"token operator\">=</span><span class=\"token number\">1001</span>,dir_mode<span class=\"token operator\">=</span>0777,file_mode<span class=\"token operator\">=</span>0777 <span class=\"token number\">0</span> <span class=\"token number\">2</span></pre></td></tr></table></figure><h2 id=\"遇到的坑\"><a class=\"anchor\" href=\"#遇到的坑\">#</a> 遇到的坑</h2>\n<blockquote>\n<p>起先挂载是不顺利 一直报错<br />\n参考链接 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTA4ODYyMTcvYXJ0aWNsZS9kZXRhaWxzLzEwMjc4MTAyMw==\">https://blog.csdn.net/u010886217/article/details/102781023</span></p>\n</blockquote>\n<div class=\"note danger\">\n<p>mount error(13): Permission denied<br />\nRefer to the mount.cifs(8) manual page (e.g. man mount.cifs) and kernel log messages (dmesg)</p>\n</div>\n<p>Windwos 的安全策略</p>\n<ul>\n<li>win+r 然后输入 “gpedit.msc”</li>\n<li>网络访问：本地账户的共享和安全模型</li>\n<li>修改设置为 “经典”</li>\n</ul>\n<p><img data-src=\"/images/linux/1.png\" alt=\"Alt\" /></p>\n",
            "tags": [
                "Linux",
                "教程",
                "Linux"
            ]
        },
        {
            "id": "https://ambercc.gitee.io/linux/vbox-share-folder/",
            "url": "https://ambercc.gitee.io/linux/vbox-share-folder/",
            "title": "Vbox共享文件夹挂载",
            "date_published": "2022-01-19T07:53:10.000Z",
            "content_html": "<h2 id=\"说明\"><a class=\"anchor\" href=\"#说明\">#</a> 说明</h2>\n<blockquote>\n<p>Vbox 的共享文件夹，方便本地开发，虚拟机中运行<br />\n可以自动挂载，但是 nginx 访问时因为权限<br />\n也可以手动挂载</p>\n</blockquote>\n<h2 id=\"自动挂载\"><a class=\"anchor\" href=\"#自动挂载\">#</a> 自动挂载</h2>\n<blockquote>\n<p>挂载后的文件夹，默认是 root 用户以及 vboxsf 组才有权限<br />\n需要把 nginx，php-fpm 的用户，用户组，加入到 vboxsf 用户组里面</p>\n</blockquote>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># usermod -aG &lt;group> &lt;user></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">usermod</span> -aG vboxsf <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">whoami</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 比如 nginx www</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">usermod</span> -aG vboxsf www</pre></td></tr></table></figure><h2 id=\"手动挂载\"><a class=\"anchor\" href=\"#手动挂载\">#</a> 手动挂载</h2>\n<blockquote>\n<p>不勾选自动挂载，则需要命令手动挂载</p>\n</blockquote>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># WWW 共享文件夹名称 /mnt/www 挂载点</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sudo</span> mount.vboxsf WWW /mnt/www</pre></td></tr></table></figure><blockquote>\n<p>也可以加入脚本中，开机自动运行</p>\n</blockquote>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 系统 20.04.1-Ubuntu</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">vi</span> /etc/init.d/mount.sh</pre></td></tr></table></figure><blockquote>\n<p>具体代码</p>\n</blockquote>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token shebang important\">#!/bin/bash</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">### BEGIN INIT INFO</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># Provides:          svnd.sh</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># Required-start:    $local_fs $remote_fs $network $syslog</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># Required-Stop:     $local_fs $remote_fs $network $syslog</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># Default-Start:     2 3 4 5</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># Default-Stop:      0 1 6</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># Short-Description: starts the svnd.sh daemon</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\"># Description:       starts svnd.sh using start-stop-daemon</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">### END INIT INFO</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token function\">sudo</span> mount.vboxsf WWW /mnt/www</pre></td></tr></table></figure>",
            "tags": [
                "Linux",
                "教程",
                "Linux"
            ]
        },
        {
            "id": "https://ambercc.gitee.io/linux/linux-php-install-redis-ext-doc/",
            "url": "https://ambercc.gitee.io/linux/linux-php-install-redis-ext-doc/",
            "title": "Linux下php安装redis拓展记录",
            "date_published": "2022-01-18T08:29:04.000Z",
            "content_html": "<h2 id=\"安装过程\"><a class=\"anchor\" href=\"#安装过程\">#</a> 安装过程</h2>\n<blockquote>\n<p>首先知道自己 php 的安装路径</p>\n</blockquote>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#查找 php-fpm</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">ps</span> aux <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> php-fpm</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#获得结果 /www/server/php/73</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>root       <span class=\"token number\">33362</span>  <span class=\"token number\">0.0</span>  <span class=\"token number\">0.4</span>  <span class=\"token number\">79540</span>  <span class=\"token number\">8384</span> ?        Ss   <span class=\"token number\">15</span>:40   <span class=\"token number\">0</span>:00 php-fpm: master process <span class=\"token punctuation\">(</span>/www/server/php/73/etc/php-fpm.conf<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><blockquote>\n<p>php 安装路径 替换成刚刚获得的路径 /www/server/php/73<br />\n 可以一步步执行 也可以把一下内容保存到 sh 脚本中执行</p>\n</blockquote>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token shebang important\">#!/bin/bash</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">wget</span> http://pecl.php.net/get/redis-4.2.0.tgz</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">tar</span> -zxvf redis-4.2.0.tgz</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token builtin class-name\">cd</span> redis-4.2.0</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>php安装路径/bin/phpize</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>./configure --with-php-config<span class=\"token operator\">=</span>php安装路径/bin/php-config</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token function\">make</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">make</span> <span class=\"token function\">install</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">#把 extension=redis.so 追加写入 php.ini 需要重启 php-fpm</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"extension=redis.so\"</span> <span class=\"token operator\">>></span> php安装路径/etc/php.ini</pre></td></tr></table></figure><blockquote>\n<p>重启 php-fpm</p>\n</blockquote>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">service</span> php-fpm restart</pre></td></tr></table></figure>",
            "tags": [
                "Linux",
                "教程",
                "Linux",
                "PHP"
            ]
        },
        {
            "id": "https://ambercc.gitee.io/fastadmin/fastadmin-doc-7/",
            "url": "https://ambercc.gitee.io/fastadmin/fastadmin-doc-7/",
            "title": "FastAdmin 个人记录 - thinkphp-queue导出Excel",
            "date_published": "2022-01-12T07:17:23.000Z",
            "content_html": "<div class=\"note primary\">\n<p><a href=\"/fastadmin/fastadmin-doc-6\">后台渲染</a><br />\n<a href=\"/fastadmin/fastadmin-doc-7\">队列导出</a></p>\n</div>\n<h2 id=\"说明\"><a class=\"anchor\" href=\"#说明\">#</a> 说明</h2>\n<p>之前关于 <a href=\"/fastadmin/fastadmin-doc-6\">后台渲染导出 Excel</a> 虽然使用 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL21rLWovUEhQX1hMU1hXcml0ZXI=\">PHP_XLSXWriter</span> 轻量封装<br />\n导出 excel，不用担心大数据量内存溢出，但是 nginx 超时，依旧影响导出大数据。</p>\n<h2 id=\"解决思路\"><a class=\"anchor\" href=\"#解决思路\">#</a> 解决思路</h2>\n<p>因为 FastAdmin 基于 TP5, 所以使用 thinkphp-queue 队列，具体可以看文档怎么使用。</p>\n<p>导出的数据超过一定量时，把导出数据需要的参数加入到队列中，让用户过段时间自行下载<br />\n执行队列任务（根据传递的参数，查询需要导出的数据，然后导出 excel 到本地）</p>\n<h2 id=\"加入队列\"><a class=\"anchor\" href=\"#加入队列\">#</a> 加入队列</h2>\n<blockquote>\n<p>主要代码</p>\n</blockquote>\n<div class=\"note info\">\n<p>注意：FastAdmin 后台控制器 中 list ($where, $sort, $order, $offset, $limit) = $this-&gt;buildparams ();<br />\n 返回的 $where 是一个匿名对象，无法直接传递给队列，也不能直接序列化<br />\n要么像下面代码中一样，把 where 条件取出来，处理成数组<br />\n要么试着使用<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2plcmVtZWFtaWEvc3VwZXJfY2xvc3VyZQ==\"> super_closure</span> 可以序列化匿名</p>\n</div>\n<figure class=\"highlight php\"><figcaption data-lang=\"PHP\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">export</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                <span class=\"token comment\">// 只展示主要代码</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                <span class=\"token variable\">$job</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'AsyncExport'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 执行队列的类名</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                <span class=\"token variable\">$queue</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'asyncexport'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 队列名</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                <span class=\"token comment\">//TODO 获取匿名对象中的 static 重组 where</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                <span class=\"token variable\">$reflection</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name class-name-fully-qualified\"><span class=\"token punctuation\">\\</span>ReflectionFunction</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$where</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                <span class=\"token variable\">$whereParams</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$reflection</span><span class=\"token operator\">-></span><span class=\"token function\">getStaticVariables</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'where'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                <span class=\"token variable\">$where2</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                <span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$whereParams</span> <span class=\"token keyword\">as</span> <span class=\"token variable\">$v</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                    <span class=\"token variable\">$where2</span><span class=\"token punctuation\">[</span><span class=\"token variable\">$v</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token variable\">$v</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$v</span><span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                <span class=\"token variable\">$data</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                    <span class=\"token variable\">$columns_arr</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                    <span class=\"token variable\">$columns</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                    <span class=\"token variable\">$where2</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                    <span class=\"token variable\">$whereIds</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                    <span class=\"token variable\">$map</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                    <span class=\"token variable\">$sort</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                    <span class=\"token variable\">$order</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                    <span class=\"token function\">get_class</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">model</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                    <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">auth</span><span class=\"token operator\">-></span><span class=\"token property\">id</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                <span class=\"token variable\">$isPushed</span> <span class=\"token operator\">=</span> <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>think<span class=\"token punctuation\">\\</span>Queue</span><span class=\"token operator\">::</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$job</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$data</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$queue</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 加入队列</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token variable\">$isPushed</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                    <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token function\">__</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'export queue Error'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token function\">success</span><span class=\"token punctuation\">(</span><span class=\"token function\">__</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'export queue Success,Please go to the export list to download,The larger the amount of data, the longer the waiting time'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight php\"><figcaption data-lang=\"PHP\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">export</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">request</span><span class=\"token operator\">-></span><span class=\"token function\">isPost</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>            <span class=\"token function\">set_time_limit</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            <span class=\"token function\">ini_set</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"memory_limit\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"256M\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            <span class=\"token variable\">$search</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">request</span><span class=\"token operator\">-></span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'search'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            <span class=\"token variable\">$ids</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">request</span><span class=\"token operator\">-></span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'ids'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token variable\">$filter</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">request</span><span class=\"token operator\">-></span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'filter'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token variable\">$op</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">request</span><span class=\"token operator\">-></span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'op'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token variable\">$sort</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">request</span><span class=\"token operator\">-></span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'sort'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token variable\">$order</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">request</span><span class=\"token operator\">-></span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'order'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            <span class=\"token variable\">$columns</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">request</span><span class=\"token operator\">-></span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'columns'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            <span class=\"token variable\">$searchList</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">request</span><span class=\"token operator\">-></span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'searchList'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            <span class=\"token variable\">$searchList</span> <span class=\"token operator\">=</span> <span class=\"token function\">json_decode</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$searchList</span><span class=\"token punctuation\">,</span><span class=\"token constant boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            <span class=\"token variable\">$whereIds</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$ids</span> <span class=\"token operator\">==</span> <span class=\"token string single-quoted-string\">'all'</span> <span class=\"token operator\">?</span> <span class=\"token string single-quoted-string\">'1=1'</span> <span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'id'</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'in'</span><span class=\"token punctuation\">,</span> <span class=\"token function\">explode</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">','</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$ids</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">request</span><span class=\"token operator\">-></span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'search'</span> <span class=\"token operator\">=></span> <span class=\"token variable\">$search</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'ids'</span> <span class=\"token operator\">=></span> <span class=\"token variable\">$ids</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'filter'</span> <span class=\"token operator\">=></span> <span class=\"token function\">urldecode</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$filter</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'op'</span> <span class=\"token operator\">=></span> <span class=\"token function\">urldecode</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$op</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'sort'</span> <span class=\"token operator\">=></span> <span class=\"token variable\">$sort</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'order'</span> <span class=\"token operator\">=></span> <span class=\"token variable\">$order</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            <span class=\"token keyword\">list</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$where</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$sort</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$order</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$offset</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$limit</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token function\">buildparams</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            <span class=\"token comment\">//$columns 是得到的字段，可以在这里写上自己的逻辑，比如删除或添加其他要写的字段</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            <span class=\"token variable\">$columns_arr</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$new_columns_arr</span> <span class=\"token operator\">=</span> <span class=\"token function\">explode</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">','</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$columns</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            <span class=\"token variable\">$key</span> <span class=\"token operator\">=</span> <span class=\"token function\">array_search</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'serviceFee'</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$columns_arr</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$key</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                <span class=\"token variable\">$new_columns_arr</span><span class=\"token punctuation\">[</span><span class=\"token variable\">$key</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"(platformFee + agentFee)/100 AS serviceFee\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                <span class=\"token variable\">$columns</span> <span class=\"token operator\">=</span> <span class=\"token function\">implode</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">','</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$new_columns_arr</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            <span class=\"token variable\">$count</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">model</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                <span class=\"token operator\">-></span><span class=\"token function\">where</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$where</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                <span class=\"token operator\">-></span><span class=\"token function\">where</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$whereIds</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                <span class=\"token operator\">-></span><span class=\"token function\">where</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$map</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                <span class=\"token operator\">-></span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            <span class=\"token comment\">// 超过一定量就加入到队列中</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$count</span> <span class=\"token operator\">></span> <span class=\"token number\">10000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                <span class=\"token variable\">$job</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'AsyncExport'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                <span class=\"token variable\">$queue</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'asyncexport'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>                <span class=\"token comment\">//TODO 获取匿名对象中的 static 重组 where</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                <span class=\"token variable\">$reflection</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name class-name-fully-qualified\"><span class=\"token punctuation\">\\</span>ReflectionFunction</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$where</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>                <span class=\"token variable\">$whereParams</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$reflection</span><span class=\"token operator\">-></span><span class=\"token function\">getStaticVariables</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'where'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>                <span class=\"token variable\">$where2</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>                <span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$whereParams</span> <span class=\"token keyword\">as</span> <span class=\"token variable\">$v</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>                    <span class=\"token variable\">$where2</span><span class=\"token punctuation\">[</span><span class=\"token variable\">$v</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token variable\">$v</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$v</span><span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>                <span class=\"token variable\">$data</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>                    <span class=\"token variable\">$columns_arr</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>                    <span class=\"token variable\">$columns</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>                    <span class=\"token variable\">$where2</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>                    <span class=\"token variable\">$whereIds</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>                    <span class=\"token variable\">$map</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>                    <span class=\"token variable\">$sort</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>                    <span class=\"token variable\">$order</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>                    <span class=\"token function\">get_class</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">model</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>                    <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">auth</span><span class=\"token operator\">-></span><span class=\"token property\">id</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>                <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>                <span class=\"token variable\">$isPushed</span> <span class=\"token operator\">=</span> <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>think<span class=\"token punctuation\">\\</span>Queue</span><span class=\"token operator\">::</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$job</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$data</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$queue</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token variable\">$isPushed</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>                    <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token function\">__</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'export queue Error'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>                <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token function\">success</span><span class=\"token punctuation\">(</span><span class=\"token function\">__</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'export queue Success,Please go to the export list to download,The larger the amount of data, the longer the waiting time'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>            <span class=\"token variable\">$title</span> <span class=\"token operator\">=</span> <span class=\"token function\">date</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"YmdHis\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>            <span class=\"token variable\">$fileName</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$title</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'.xlsx'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>            <span class=\"token variable\">$writer</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">XLSXWriter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>            <span class=\"token variable\">$sheet</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'Sheet1'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>            <span class=\"token comment\">// 处理标题数据，都设置为 string 类型</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>            <span class=\"token variable\">$header</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>            <span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$columns_arr</span> <span class=\"token keyword\">as</span> <span class=\"token variable\">$value</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>                <span class=\"token variable\">$header</span><span class=\"token punctuation\">[</span><span class=\"token function\">__</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$value</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span>  <span class=\"token string single-quoted-string\">'string'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 把表头的数据全部设置为 string 类型</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>            <span class=\"token variable\">$writer</span><span class=\"token operator\">-></span><span class=\"token function\">writeSheetHeader</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$sheet</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$header</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>            <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">model</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>                <span class=\"token operator\">-></span><span class=\"token function\">field</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$columns</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>                <span class=\"token operator\">-></span><span class=\"token function\">where</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$where</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>                <span class=\"token operator\">-></span><span class=\"token function\">where</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$whereIds</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>                <span class=\"token operator\">-></span><span class=\"token function\">where</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$map</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>                <span class=\"token operator\">-></span><span class=\"token function\">chunk</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$items</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">use</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span><span class=\"token variable\">$list</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span><span class=\"token variable\">$writer</span><span class=\"token punctuation\">,</span><span class=\"token operator\">&amp;</span><span class=\"token variable\">$columns_arr</span><span class=\"token punctuation\">,</span><span class=\"token operator\">&amp;</span><span class=\"token variable\">$searchList</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>                    <span class=\"token variable\">$list</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$items</span> <span class=\"token operator\">=</span> <span class=\"token function\">collection</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$items</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">toArray</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>                    <span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$items</span> <span class=\"token keyword\">as</span> <span class=\"token variable\">$index</span> <span class=\"token operator\">=></span> <span class=\"token variable\">$item</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>                        <span class=\"token comment\">// 根据标题数据 title，按 title 的字段顺序把数据一条条加到 excel 中</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>                        <span class=\"token variable\">$sheet</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'Sheet1'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>                        <span class=\"token variable\">$row</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>                        <span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$item</span> <span class=\"token keyword\">as</span> <span class=\"token variable\">$field</span> <span class=\"token operator\">=></span> <span class=\"token variable\">$value</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>                            <span class=\"token comment\">// 只导出传递的字段 过滤 createtime_text 等 modeld 中的附加字段</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>                            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">in_array</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$field</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$columns_arr</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>                            <span class=\"token comment\">// 根据前端传递的 $searchList 处理状态等</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>                            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$searchList</span><span class=\"token punctuation\">[</span><span class=\"token variable\">$field</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>                                <span class=\"token variable\">$value</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$searchList</span><span class=\"token punctuation\">[</span><span class=\"token variable\">$field</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token variable\">$value</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">??</span> <span class=\"token variable\">$value</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>                            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>                            <span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token variable\">$field</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$value</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>                        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>                        <span class=\"token variable\">$writer</span><span class=\"token operator\">-></span><span class=\"token function\">writeSheetRow</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$sheet</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$row</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$sort</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$order</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre></pre></td></tr><tr><td data-num=\"107\"></td><td><pre></pre></td></tr><tr><td data-num=\"108\"></td><td><pre></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>            <span class=\"token comment\">// 设置 header，用于浏览器下载</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>            <span class=\"token function\">header</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'Content-disposition: attachment; filename=\"'</span><span class=\"token operator\">.</span><span class=\"token class-name static-context\">XLSXWriter</span><span class=\"token operator\">::</span><span class=\"token function\">sanitize_filename</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$fileName</span><span class=\"token punctuation\">)</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'\"'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>            <span class=\"token function\">header</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>            <span class=\"token function\">header</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'Content-Transfer-Encoding: binary'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>            <span class=\"token function\">header</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'Cache-Control: must-revalidate'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>            <span class=\"token function\">header</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'Pragma: public'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>            <span class=\"token variable\">$writer</span><span class=\"token operator\">-></span><span class=\"token function\">writeToStdOut</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>            <span class=\"token keyword\">exit</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"队列方法\"><a class=\"anchor\" href=\"#队列方法\">#</a> 队列方法</h2>\n<figure class=\"highlight php\"><figcaption data-lang=\"PHP\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">namespace</span> <span class=\"token package\">app<span class=\"token punctuation\">\\</span>job</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">use</span> <span class=\"token package\">app<span class=\"token punctuation\">\\</span>common<span class=\"token punctuation\">\\</span>library<span class=\"token punctuation\">\\</span>XLSXWriter</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">use</span> <span class=\"token package\">fast<span class=\"token punctuation\">\\</span>Random</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">use</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>Exception</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">use</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>queue<span class=\"token punctuation\">\\</span>Job</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">AsyncExport</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token comment\">// 只展示主要代码，省略部分 具体查看 think-queue 的具体使用</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>     * 根据消息中的数据进行实际的业务处理...</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>     */</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">doJob</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$data</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token comment\">// 整理传递到队列的参数</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token keyword\">list</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$columns_arr</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$columns</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$where</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$whereIds</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$map</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$sort</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$order</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$model</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$admin_id</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$data</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token comment\">//$title = date(\"YmdHis\");</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token variable\">$title</span> <span class=\"token operator\">=</span> <span class=\"token class-name static-context\">Random</span><span class=\"token operator\">::</span><span class=\"token function\">alnum</span><span class=\"token punctuation\">(</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token variable\">$fileName</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$title</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'.xlsx'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token variable\">$writer</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">XLSXWriter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token variable\">$sheet</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'Sheet1'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token comment\">// 处理标题数据，都设置为 string 类型</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token variable\">$header</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$columns_arr</span> <span class=\"token keyword\">as</span> <span class=\"token variable\">$value</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            <span class=\"token variable\">$header</span><span class=\"token punctuation\">[</span><span class=\"token function\">__</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$value</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span>  <span class=\"token string single-quoted-string\">'string'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 把表头的数据全部设置为 string 类型</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token variable\">$writer</span><span class=\"token operator\">-></span><span class=\"token function\">writeSheetHeader</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$sheet</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$header</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token function\">model</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$model</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            <span class=\"token operator\">-></span><span class=\"token function\">field</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$columns</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            <span class=\"token operator\">-></span><span class=\"token function\">where</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$where</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            <span class=\"token operator\">-></span><span class=\"token function\">where</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$whereIds</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            <span class=\"token operator\">-></span><span class=\"token function\">where</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$map</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            <span class=\"token operator\">-></span><span class=\"token function\">chunk</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$items</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">use</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span><span class=\"token variable\">$list</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span><span class=\"token variable\">$writer</span><span class=\"token punctuation\">,</span><span class=\"token operator\">&amp;</span><span class=\"token variable\">$columns_arr</span><span class=\"token punctuation\">,</span><span class=\"token operator\">&amp;</span><span class=\"token variable\">$searchList</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                <span class=\"token variable\">$list</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$items</span> <span class=\"token operator\">=</span> <span class=\"token function\">collection</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$items</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">toArray</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>                <span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$items</span> <span class=\"token keyword\">as</span> <span class=\"token variable\">$index</span> <span class=\"token operator\">=></span> <span class=\"token variable\">$item</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>                    <span class=\"token comment\">// 根据标题数据 title，按 title 的字段顺序把数据一条条加到 excel 中</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>                    <span class=\"token variable\">$sheet</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'Sheet1'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>                    <span class=\"token variable\">$row</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                    <span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$item</span> <span class=\"token keyword\">as</span> <span class=\"token variable\">$field</span> <span class=\"token operator\">=></span> <span class=\"token variable\">$value</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>                        <span class=\"token comment\">// 只导出传递的字段 过滤 createtime_text 等 modeld 中的附加字段</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>                        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">in_array</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$field</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$columns_arr</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>                        <span class=\"token comment\">// 根据前端传递的 $searchList 处理状态等</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>                        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$searchList</span><span class=\"token punctuation\">[</span><span class=\"token variable\">$field</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>                            <span class=\"token variable\">$value</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$searchList</span><span class=\"token punctuation\">[</span><span class=\"token variable\">$field</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token variable\">$value</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">??</span> <span class=\"token variable\">$value</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>                        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>                        <span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token variable\">$field</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$value</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>                    <span class=\"token variable\">$writer</span><span class=\"token operator\">-></span><span class=\"token function\">writeSheetRow</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$sheet</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$row</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$sort</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$order</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>        <span class=\"token variable\">$output_dir</span> <span class=\"token operator\">=</span> <span class=\"token constant\">ROOT_PATH</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'public'</span> <span class=\"token operator\">.</span> <span class=\"token constant\">DS</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'export'</span> <span class=\"token operator\">.</span> <span class=\"token constant\">DS</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$fileName</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        <span class=\"token variable\">$writer</span><span class=\"token operator\">-></span><span class=\"token function\">writeToFile</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$output_dir</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>        <span class=\"token variable\">$insertData</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>            <span class=\"token string single-quoted-string\">'filename'</span>  <span class=\"token operator\">=></span> <span class=\"token variable\">$fileName</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>            <span class=\"token string single-quoted-string\">'filesize'</span>  <span class=\"token operator\">=></span> <span class=\"token function\">filesize</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$output_dir</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>            <span class=\"token string single-quoted-string\">'url'</span>       <span class=\"token operator\">=></span> <span class=\"token constant\">DS</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'export'</span> <span class=\"token operator\">.</span> <span class=\"token constant\">DS</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$fileName</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>            <span class=\"token string single-quoted-string\">'mimetype'</span>  <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'xlsx'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>            <span class=\"token string single-quoted-string\">'model'</span>     <span class=\"token operator\">=></span> <span class=\"token variable\">$model</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>            <span class=\"token string single-quoted-string\">'admin_id'</span>  <span class=\"token operator\">=></span> <span class=\"token variable\">$admin_id</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>            <span class=\"token string single-quoted-string\">'createtime'</span> <span class=\"token operator\">=></span> <span class=\"token function\">time</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>        <span class=\"token comment\">//excel 导出后保存在服务器 这里把导出的 excel 基本信息和路径保存在表中 给用户展示 方便下载</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>        <span class=\"token function\">model</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'app\\admin\\model\\ExportList'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">insert</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$insertData</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre><span class=\"token punctuation\">&#125;</span></span></pre></td></tr></table></figure><h2 id=\"保存导出记录\"><a class=\"anchor\" href=\"#保存导出记录\">#</a> 保存导出记录</h2>\n<blockquote>\n<p>导出表 记录导出的 excel<br />\nadmin_id 用来区分是谁下载的，只给他显示自己下载的</p>\n</blockquote>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> <span class=\"token punctuation\">`</span>t_export_list<span class=\"token punctuation\">`</span>  <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token punctuation\">`</span>id<span class=\"token punctuation\">`</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">AUTO_INCREMENT</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'ID'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token punctuation\">`</span>filename<span class=\"token punctuation\">`</span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">50</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">CHARACTER</span> <span class=\"token keyword\">SET</span> utf8mb4 <span class=\"token keyword\">COLLATE</span> utf8mb4_general_ci <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'文件名'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token punctuation\">`</span>url<span class=\"token punctuation\">`</span> <span class=\"token keyword\">text</span> <span class=\"token keyword\">CHARACTER</span> <span class=\"token keyword\">SET</span> utf8mb4 <span class=\"token keyword\">COLLATE</span> utf8mb4_general_ci <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'文件路径'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token punctuation\">`</span>filesize<span class=\"token punctuation\">`</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'文件大小'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token punctuation\">`</span>mimetype<span class=\"token punctuation\">`</span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">50</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">CHARACTER</span> <span class=\"token keyword\">SET</span> utf8mb4 <span class=\"token keyword\">COLLATE</span> utf8mb4_general_ci <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'mime类型'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token punctuation\">`</span>admin_id<span class=\"token punctuation\">`</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'管理员ID'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">`</span>model<span class=\"token punctuation\">`</span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">CHARACTER</span> <span class=\"token keyword\">SET</span> utf8mb4 <span class=\"token keyword\">COLLATE</span> utf8mb4_general_ci <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'导出model'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token punctuation\">`</span>createtime<span class=\"token punctuation\">`</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'创建时间'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">`</span>id<span class=\"token punctuation\">`</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">USING</span> <span class=\"token keyword\">BTREE</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token keyword\">INDEX</span> <span class=\"token punctuation\">`</span>admin_id<span class=\"token punctuation\">`</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">`</span>admin_id<span class=\"token punctuation\">`</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">USING</span> <span class=\"token keyword\">BTREE</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">)</span> <span class=\"token keyword\">ENGINE</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">InnoDB</span> <span class=\"token keyword\">AUTO_INCREMENT</span> <span class=\"token operator\">=</span> <span class=\"token number\">10</span> <span class=\"token keyword\">CHARACTER</span> <span class=\"token keyword\">SET</span> <span class=\"token operator\">=</span> utf8mb4 <span class=\"token keyword\">COLLATE</span> <span class=\"token operator\">=</span> utf8mb4_general_ci ROW_FORMAT <span class=\"token operator\">=</span> Compact<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><blockquote>\n<p>FastAdmin 对应导出列表的控制器</p>\n</blockquote>\n<figure class=\"highlight php\"><figcaption data-lang=\"PHP\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">namespace</span> <span class=\"token package\">app<span class=\"token punctuation\">\\</span>admin<span class=\"token punctuation\">\\</span>controller<span class=\"token punctuation\">\\</span>general</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">use</span> <span class=\"token package\">app<span class=\"token punctuation\">\\</span>common<span class=\"token punctuation\">\\</span>controller<span class=\"token punctuation\">\\</span>Backend</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"8\"></td><td><pre> * </pre></td></tr><tr><td data-num=\"9\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"10\"></td><td><pre> * @icon fa fa-circle-o</pre></td></tr><tr><td data-num=\"11\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">Exportlist</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Backend</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$dataLimit</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 开启后台默认 根据 admin_id 做数据限制</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></span></pre></td></tr></table></figure><h2 id=\"效果展示\"><a class=\"anchor\" href=\"#效果展示\">#</a> 效果展示</h2>\n<p><img data-src=\"https://cdn.jsdelivr.net/gh/amber6hua/cdn@master/image-hosting/7-1.1s7cyvc47su8.webp\" alt=\"7-1\" /></p>\n",
            "tags": [
                "FastAdmin",
                "教程",
                "FastAdmin"
            ]
        },
        {
            "id": "https://ambercc.gitee.io/onedrive-onemanager-heroku-doc/",
            "url": "https://ambercc.gitee.io/onedrive-onemanager-heroku-doc/",
            "title": "oneDrive + oneManager + heroku 部署个人网盘",
            "date_published": "2021-12-31T09:21:26.000Z",
            "content_html": "<h2 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h2>\n<p>之前看到很多 oneindex, 不知道是什么<br />\n突然看到 oneManager + OneDrive 而且部署方便，可以部署在 heroku 上就尝试整了下<br />\n在此记录下过程</p>\n<h2 id=\"说明\"><a class=\"anchor\" href=\"#说明\">#</a> 说明</h2>\n<p>oneDrive 微软的网盘，听说速度不错，容量免费 操作下可以有 5T<br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3FrcXB0dGdmL09uZU1hbmFnZXItcGhw\">oneManager</span> 可以在网页管理各种网盘，当作个人云盘<br />\n heroku 免费提供各种部署环境</p>\n<h2 id=\"申请onedrive-5t-空间\"><a class=\"anchor\" href=\"#申请onedrive-5t-空间\">#</a> 申请 oneDrive 5T 空间</h2>\n<ul>\n<li>首先需要微软账户</li>\n<li>然后注册 Office 365 开发人员 并申请 E5 订阅</li>\n<li>用申请成功的管理员账户登录<span class=\"exturl\" data-url=\"aHR0cHM6Ly9hZG1pbi5vbmVkcml2ZS5jb20vP3Y9U3RvcmFnZVNldHRpbmdz\"> sharepoint 管理中心</span> ，选择设置 更改存储限制 为 5120GB，不然默认只开放 1T。</li>\n</ul>\n<blockquote>\n<p>参考链接：<span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8xMDU0Mzg4MTc/dXRtX3NvdXJjZT1aSFNoYXJlVGFyZ2V0SURNb3Jl\">https://zhuanlan.zhihu.com/p/105438817?utm_source=ZHShareTargetIDMore</span></p>\n</blockquote>\n<h2 id=\"onemanager-heroku-在线管理网盘\"><a class=\"anchor\" href=\"#onemanager-heroku-在线管理网盘\">#</a> oneManager + heroku 在线管理网盘</h2>\n<h3 id=\"heroku-部署\"><a class=\"anchor\" href=\"#heroku-部署\">#</a> heroku 部署</h3>\n<ul>\n<li>首先 在 github fork <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3FrcXB0dGdmL09uZU1hbmFnZXItcGhw\">oneManager</span> 这个项目到自己的账户下备用</li>\n<li>heroku 新建一个应用，打开后在 deploy 分页下 关联自己 fork 的项目，在点击按钮 deploy branch 部署</li>\n<li>成功后会跳转 oneManager 的安装页面，逐步安装就行</li>\n</ul>\n<blockquote>\n<p>参考链接：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cubmJtYW8uY29tL2FyY2hpdmVzLzQwMTQ=\">https://www.nbmao.com/archives/4014</span></p>\n</blockquote>\n<div class=\"note info\">\n<p>注意事项：</p>\n<ul>\n<li>oneManager 安装过程中 新建 apikey 会新页面打开 heroku 复制里面的 api 密钥</li>\n</ul>\n</div>\n<h3 id=\"onemanager添加网盘\"><a class=\"anchor\" href=\"#onemanager添加网盘\">#</a> oneManager 添加网盘</h3>\n<blockquote>\n<p>安装完成后通过安装过程中设置的密码登录后台，可以添加网盘和设置 oneManager 基本配置</p>\n</blockquote>\n<ul>\n<li>添加 onedrive<br />\n 以免费申请订阅的 365 e5 为例<br />\n Select Account Type 选择 MS: 国际版（商业版与个人版）<br />\n勾选 用自己申请的应用 ID 与机密，点击页面上的超链接，跳转到<span class=\"exturl\" data-url=\"aHR0cHM6Ly9wb3J0YWwuYXp1cmUuY29t\">开发者后台</span>自己申请应用并创建密钥，获得对应的 client_id 和 client_secret</li>\n</ul>\n<div class=\"note info\">\n<p>注意：onedrive 创建应用时 需要选择第二个选项 任何组织目录 (任何 Azure AD 目录 - 多租户) 中的帐户<br />\n并选择重定向 url 类型 web 填写 back url (oneManager 有提示：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9zY2ZvbmVkcml2ZS5naXRodWIuaW8=\">https://scfonedrive.github.io</span>)</p>\n</div>\n<blockquote>\n<p>参考链接 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTAzODA5MDUvYXJ0aWNsZS9kZXRhaWxzLzEwODYyODcxMw==\">https://blog.csdn.net/u010380905/article/details/108628713</span></p>\n</blockquote>\n<ul>\n<li>添加阿里网盘</li>\n</ul>\n<blockquote>\n<p>阿里网盘只需要填写 Refresh Token，获取方式需要通过阿里网盘手机 app 的日志获取 日志路径 Android/data/com.alicloud.databox/files/logs/trace/<br />\n 参考链接 <span class=\"exturl\" data-url=\"aHR0cHM6Ly93cC5neG5hcy5jb20vMTAzOTguaHRtbA==\">https://wp.gxnas.com/10398.html</span></p>\n</blockquote>\n<h3 id=\"onemanager配置\"><a class=\"anchor\" href=\"#onemanager配置\">#</a> oneManager 配置</h3>\n<p>隐藏登录、设置主题、美化等</p>\n<blockquote>\n<p>参考链接 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L211emlodWFuZXIvYXJ0aWNsZS9kZXRhaWxzLzEwNzg1Mzc1NQ==\">https://blog.csdn.net/muzihuaner/article/details/107853755</span></p>\n</blockquote>\n",
            "tags": [
                "教程",
                "教程"
            ]
        }
    ]
}